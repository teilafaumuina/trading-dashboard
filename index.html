<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Teila's Trading Dashboard</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    body {
      margin: 0;
      background: #0a0a0a;
      color: #fff;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #1a1a1a; }
    ::-webkit-scrollbar-thumb { background: #3a3a3a; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #4a4a4a; }

    /* Calendar */
    .calendar-day { position: relative; transition: all 0.2s ease; cursor: pointer; }
    .calendar-day-profit:hover { transform: scale(1.05); z-index: 10; box-shadow: 0 0 20px rgba(16, 185, 129, 0.3); }
    .calendar-day-loss:hover { transform: scale(1.05); z-index: 10; box-shadow: 0 0 20px rgba(239, 68, 68, 0.3); }
    .calendar-day-neutral:hover { transform: scale(1.05); z-index: 10; box-shadow: 0 0 20px rgba(107, 114, 128, 0.3); }
    
    .calendar-tooltip {
      position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%) translateY(-8px);
      background: #1a1a1a; border: 1px solid #3a3a3a; border-radius: 8px; padding: 12px;
      visibility: hidden; opacity: 0; transition: opacity 0.3s, visibility 0.3s;
      min-width: 220px; z-index: 100; box-shadow: 0 10px 25px rgba(0,0,0,0.8);
    }
    .calendar-day:hover .calendar-tooltip { visibility: visible; opacity: 1; }

    /* UI Elements */
    .metric-card { background: linear-gradient(135deg, #1a1a1a 0%, #141414 100%); transition: all 0.3s ease; }
    .metric-card:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5); }
    
    .trade-row:hover { background: rgba(255, 255, 255, 0.03); cursor: pointer; }
    
    .pagination-btn { background: #2a2a2a; border: 1px solid #3a3a3a; padding: 8px 16px; border-radius: 4px; transition: all 0.2s ease; }
    .pagination-btn:hover:not(:disabled) { background: #3a3a3a; transform: translateY(-1px); }
    .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* MODAL STYLES */
    .modal-overlay {
      background-color: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(5px);
    }
    .nav-arrow {
      position: absolute; top: 50%; transform: translateY(-50%);
      background: rgba(30, 30, 30, 0.8); border: 1px solid #444;
      color: white; width: 60px; height: 60px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.2s; z-index: 60;
      font-size: 24px; user-select: none;
    }
    .nav-arrow:hover { background: #10b981; border-color: #10b981; }
    .nav-arrow:active { transform: translateY(-50%) scale(0.95); }
    .nav-arrow.left { left: 30px; }
    .nav-arrow.right { right: 30px; }

    /* Process Tag Styles */
    .process-tag { font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; display: inline-block; }
    .tag-green { background: rgba(16, 185, 129, 0.2); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.3); }
    .tag-red { background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3); }
    .tag-gray { background: #2a2a2a; color: #9ca3af; border: 1px solid #374151; }

    @media (max-width: 1024px) {
      .nav-arrow { width: 40px; height: 40px; font-size: 18px; top: auto; bottom: 20px; transform: none; }
      .nav-arrow.left { left: 20px; }
      .nav-arrow.right { right: 20px; }
      .table-container { overflow-x: auto; }
      table { min-width: 600px; }
      .hide-mobile { display: none; }
    }
  </style>
</head>
<body class="bg-[#0a0a0a] text-white">

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- TRADE DETAIL MODAL (Gallery View) -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="tradeModal" class="hidden fixed inset-0 z-[999] modal-overlay flex items-center justify-center p-2 lg:p-8">
    
    <!-- Navigation Arrows -->
    <button onclick="navigateTrade(-1)" class="nav-arrow left">‚ùÆ</button>
    <button onclick="navigateTrade(1)" class="nav-arrow right">‚ùØ</button>

    <!-- Modal Content -->
    <div class="bg-[#111] border border-[#333] w-full max-w-7xl h-[90vh] rounded-xl overflow-hidden flex flex-col shadow-2xl relative z-50">
      
      <!-- Modal Header -->
      <div class="flex justify-between items-center p-4 border-b border-[#333] bg-[#161616]">
        <div class="flex items-center gap-3 md:gap-6">
          <div>
            <h2 id="m_tradeId" class="text-2xl font-bold font-mono text-white">--</h2>
            <p id="m_date" class="text-gray-400 text-xs mt-0.5">--</p>
          </div>
          
          <div class="h-8 w-px bg-[#333]"></div>
          
          <div class="flex flex-col">
            <span class="text-[10px] uppercase text-gray-500 font-semibold">Result</span>
            <span id="m_pnl" class="text-lg font-bold">--</span>
          </div>

          <div class="h-8 w-px bg-[#333] hide-mobile"></div>

          <div class="hide-mobile">
            <span id="m_symbol" class="px-2 py-1 rounded bg-[#222] border border-[#333] text-xs font-mono text-gray-300">--</span>
            <span id="m_side" class="px-2 py-1 rounded text-xs font-bold ml-2">--</span>
          </div>
        </div>
        <button onclick="closeModal()" class="text-gray-400 hover:text-white text-3xl leading-none px-2">&times;</button>
      </div>

      <!-- Modal Body (Split View) -->
      <div class="flex-1 overflow-hidden flex flex-col lg:flex-row">
        
        <!-- LEFT: Chart/Screenshot -->
        <div class="w-full lg:w-2/3 bg-black flex items-center justify-center border-b lg:border-b-0 lg:border-r border-[#333] relative group h-1/2 lg:h-full">
          <img id="m_image" src="" alt="Trade Chart" class="max-w-full max-h-full object-contain">
          
          <div id="m_no_image" class="hidden flex flex-col items-center justify-center text-gray-600">
            <svg class="w-16 h-16 mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            <span>No Screenshot Available</span>
          </div>

          <a id="m_full_image_link" href="#" target="_blank" class="absolute top-4 right-4 bg-black/80 hover:bg-[#222] border border-[#444] text-white px-3 py-1.5 rounded text-xs transition-colors flex items-center gap-2">
            <span>Open Original</span>
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
          </a>
        </div>

        <!-- RIGHT: Data & Journal -->
        <div class="w-full lg:w-1/3 bg-[#111] overflow-y-auto h-1/2 lg:h-full flex flex-col">
          
          <!-- Quick Stats Grid -->
          <div class="grid grid-cols-2 gap-px bg-[#333] border-b border-[#333]">
            <div class="bg-[#161616] p-4">
              <span class="text-gray-500 text-[10px] uppercase block">Entry</span>
              <span id="m_entry_price" class="text-sm font-mono text-white">--</span>
            </div>
            <div class="bg-[#161616] p-4">
              <span class="text-gray-500 text-[10px] uppercase block">Exit</span>
              <span id="m_exit_price" class="text-sm font-mono text-white">--</span>
            </div>
            <div class="bg-[#161616] p-4">
              <span class="text-gray-500 text-[10px] uppercase block">Setup</span>
              <span id="m_setup" class="text-sm text-blue-300">--</span>
            </div>
            <div class="bg-[#161616] p-4">
              <span class="text-gray-500 text-[10px] uppercase block">Score</span>
              <span id="m_score" class="text-sm font-bold text-yellow-400">--</span>
            </div>
          </div>

          <!-- Process Checklist (New Columns) -->
          <div class="p-6 border-b border-[#2a2a2a]">
            <h3 class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-4">Execution Process</h3>
            <div class="space-y-3">
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-400">Pre-Trade</span>
                <span id="m_tag_pre" class="process-tag">--</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-400">Entry</span>
                <span id="m_tag_entry" class="process-tag">--</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-400">Management</span>
                <span id="m_tag_mgmt" class="process-tag">--</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-400">Exit</span>
                <span id="m_tag_exit" class="process-tag">--</span>
              </div>
            </div>
          </div>

          <!-- Journal Notes -->
          <div class="p-6 flex-1">
            <h3 class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-3">Journal Notes</h3>
            <div class="bg-[#1a1a1a] rounded p-4 border border-[#2a2a2a]">
              <p id="m_notes" class="text-sm text-gray-300 leading-relaxed whitespace-pre-wrap">--</p>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Loading / Error States -->
  <div id="loadingState" class="fixed inset-0 bg-[#0a0a0a] flex items-center justify-center z-50">
    <div class="text-center">
      <div class="loading-spinner mx-auto mb-4"></div>
      <p class="text-gray-400">Loading trading data...</p>
    </div>
  </div>
  <div id="errorState" class="hidden fixed inset-0 bg-[#0a0a0a] flex items-center justify-center z-50">
    <div class="text-center p-8 bg-[#1a1a1a] rounded-lg border border-red-900">
      <div class="text-red-400 text-6xl mb-4">‚ö†Ô∏è</div>
      <h2 class="text-xl font-semibold mb-2">Failed to Load Data</h2>
      <button onclick="location.reload()" class="px-4 py-2 bg-red-900 hover:bg-red-800 rounded">Retry</button>
    </div>
  </div>

  <!-- Main Dashboard -->
  <div id="mainDashboard" class="hidden min-h-screen p-4 md:p-6 max-w-7xl mx-auto">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-8 gap-4">
      <h1 class="text-2xl sm:text-3xl font-bold flex items-center">
        Teila's Trading Dashboard 
        <span class="w-3 h-3 bg-green-400 rounded-full ml-3 animate-pulse"></span>
      </h1>
      <div class="text-sm text-gray-400">Last updated: <span id="lastUpdated"></span></div>
    </div>

    <!-- Metrics -->
    <div id="metricsContainer" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8"></div>

    <!-- Equity -->
    <div class="bg-[#1a1a1a] p-6 rounded-lg border border-[#2a2a2a] mb-8">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold">Equity Curve</h2>
        <div class="flex space-x-2">
          <button id="equityByTrades" class="px-3 py-1 text-sm rounded bg-[#2a2a2a]" onclick="switchEquityView('trades')">Trades</button>
          <button id="equityByDays" class="px-3 py-1 text-sm rounded bg-[#1a1a1a] text-gray-400" onclick="switchEquityView('days')">Days</button>
        </div>
      </div>
      <div class="chart-container"><canvas id="equityChart"></canvas></div>
    </div>

    <!-- Calendar & Evaluation -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
      <div class="lg:col-span-2 bg-[#1a1a1a] p-6 rounded-lg border border-[#2a2a2a]">
        <div class="flex justify-between items-center mb-4">
          <button onclick="changeCalendarMonth(-1)" class="p-2 hover:bg-[#2a2a2a] rounded">‚ùÆ</button>
          <h2 id="calendarMonthYear" class="text-lg font-semibold"></h2>
          <button onclick="changeCalendarMonth(1)" class="p-2 hover:bg-[#2a2a2a] rounded">‚ùØ</button>
        </div>
        <div class="grid grid-cols-7 gap-2 text-center text-gray-500 text-xs mb-2"><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div></div>
        <div id="calendarGrid" class="grid grid-cols-7 gap-2"></div>
      </div>
      <div class="bg-[#1a1a1a] p-6 rounded-lg border border-[#2a2a2a]">
        <h2 class="text-lg font-semibold mb-6">Evaluation</h2>
        <div id="evaluationPanel" class="space-y-4"></div>
      </div>
    </div>

    <!-- Analysis Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <div class="bg-[#1a1a1a] p-6 rounded-lg border border-[#2a2a2a]">
        <h2 class="text-lg font-semibold mb-4">Top Performing Symbols</h2>
        <div id="symbolPerformance" class="space-y-2"></div>
      </div>
      <div class="bg-[#1a1a1a] p-6 rounded-lg border border-[#2a2a2a]">
        <h2 class="text-lg font-semibold mb-4">Best Trading Times</h2>
        <div class="chart-container h-64"><canvas id="timeAnalysisChart"></canvas></div>
      </div>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <div class="bg-[#1a1a1a] p-6 rounded-lg border border-[#2a2a2a]"><h2 class="text-lg font-semibold mb-6">By Symbol</h2><div class="chart-container"><canvas id="symbolChart"></canvas></div></div>
      <div class="bg-[#1a1a1a] p-6 rounded-lg border border-[#2a2a2a]"><h2 class="text-lg font-semibold mb-6">By Weekday</h2><div class="chart-container"><canvas id="weekdayChart"></canvas></div></div>
    </div>

    <!-- Insights -->
    <div id="insightsContainer" class="mb-8"></div>

    <!-- Trade Table -->
    <div class="bg-[#1a1a1a] p-6 rounded-lg border border-[#2a2a2a]">
      <div class="flex flex-col gap-4 mb-4">
        <h2 class="text-lg font-semibold">Trade History</h2>
        <div class="flex flex-col sm:flex-row justify-between gap-4">
          <span id="paginationInfo" class="text-sm text-gray-400"></span>
          <div class="flex gap-2">
            <input type="text" id="tradeSearch" placeholder="Search..." class="px-3 py-2 bg-[#0a0a0a] border border-[#2a2a2a] rounded text-sm w-full" onkeyup="filterTrades()"/>
            <select id="tradeFilter" class="px-3 py-2 bg-[#0a0a0a] border border-[#2a2a2a] rounded text-sm" onchange="filterTrades()">
              <option value="">All</option><option value="win">Winners</option><option value="loss">Losers</option>
            </select>
          </div>
          <div class="flex gap-2">
            <button id="prevPage" class="pagination-btn" onclick="changePage(-1)">‚ùÆ</button>
            <button id="nextPage" class="pagination-btn" onclick="changePage(1)">‚ùØ</button>
          </div>
        </div>
      </div>
      <div class="table-container">
        <table class="w-full text-sm">
          <thead class="border-b border-[#2a2a2a]">
            <tr>
              <th class="py-3 px-4 text-left">Trade ID</th>
              <th class="py-3 px-4 text-left">Date</th>
              <th class="py-3 px-4 text-left">Symbol</th>
              <th class="py-3 px-4 text-left hide-mobile">Side</th>
              <th class="py-3 px-4 text-left hide-mobile">Entry</th>
              <th class="py-3 px-4 text-left hide-mobile">Exit</th>
              <th class="py-3 px-4 text-right">P&L</th>
              <th class="py-3 px-4 text-center">Chart</th>
            </tr>
          </thead>
          <tbody id="tradesTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // ‚ïê‚ïê‚ïê‚ïê CONFIG ‚ïê‚ïê‚ïê‚ïê
    const DATA_URL = './data.json?v=' + new Date().getTime();

    // ‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê
    let rawData = {}, allTrades = [], filteredTrades = [];
    let currentPage = 1, tradesPerPage = 10;
    let equityChart, timeChart, symbolChart, weekdayChart;
    let modalOpen = false, currentTradeIndex = -1;

    // ‚ïê‚ïê‚ïê‚ïê UTILS ‚ïê‚ïê‚ïê‚ïê
    const formatMoney = (v) => (parseFloat(v)||0)>=0 ? '+$'+Math.abs(v).toFixed(2) : '-$'+Math.abs(v).toFixed(2);
    const parseMoneyValue = (v) => { if(!v)return 0; const c=v.toString().replace(/[$,]/g,''); return isNaN(parseFloat(c))?0:parseFloat(c); };
    const getNetPnL = (t) => parseMoneyValue(t.p_l) - parseMoneyValue(t.fees||0);
    const driveUrls = (url) => {
      if(!url) return {thumb:null,full:null};
      const m = url.match(/\/file\/d\/([\w-]+)/);
      return m ? {thumb:`https://drive.google.com/thumbnail?id=${m[1]}&sz=w400`, full:`https://drive.google.com/uc?id=${m[1]}`} : {thumb:url,full:url};
    };

    // ‚ïê‚ïê‚ïê‚ïê MODAL LOGIC ‚ïê‚ïê‚ïê‚ïê
    function openTradeModal(tradeId) {
      const idx = allTrades.findIndex(t => t.trade_id === tradeId);
      if(idx === -1) return;
      currentTradeIndex = idx;
      renderModalContent();
      document.getElementById('tradeModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      modalOpen = true;
    }

    function closeModal() {
      document.getElementById('tradeModal').classList.add('hidden');
      document.body.style.overflow = '';
      modalOpen = false;
    }

    function navigateTrade(dir) {
      if(!modalOpen) return;
      const next = currentTradeIndex + dir;
      if(next >= 0 && next < allTrades.length) {
        currentTradeIndex = next;
        renderModalContent();
      }
    }

    function renderModalContent() {
      const t = allTrades[currentTradeIndex];
      if(!t) return;

      // 1. Header
      document.getElementById('m_tradeId').textContent = t.trade_id;
      document.getElementById('m_date').textContent = `${t.date} ${t.entry_time}`;
      document.getElementById('m_symbol').textContent = t.symbol;
      
      const pnl = parseMoneyValue(t.p_l);
      const pnlEl = document.getElementById('m_pnl');
      pnlEl.textContent = formatMoney(pnl);
      pnlEl.className = `text-lg font-bold ${pnl>=0 ? 'text-green-400':'text-red-400'}`;

      const sideEl = document.getElementById('m_side');
      sideEl.textContent = t.side || '-';
      sideEl.className = `px-2 py-1 rounded text-xs font-bold ml-2 ${t.side?.toLowerCase()==='short'?'bg-red-900 text-red-200':'bg-green-900 text-green-200'}`;

      // 2. Image
      // Check ALL possible screenshot fields from different versions
      const rawUrl = t.screenshot || t.screenshot_url_A || t.screenshot_url_B || '';
      const { full } = driveUrls(rawUrl);
      const img = document.getElementById('m_image');
      const noImg = document.getElementById('m_no_image');
      const fullLink = document.getElementById('m_full_image_link');

      if(full) {
        img.src = full; img.classList.remove('hidden'); noImg.classList.add('hidden');
        fullLink.href = full; fullLink.classList.remove('hidden');
      } else {
        img.classList.add('hidden'); noImg.classList.remove('hidden'); fullLink.classList.add('hidden');
      }

      // 3. Stats Grid
      document.getElementById('m_entry_price').textContent = parseFloat(t.entry_price).toFixed(2);
      document.getElementById('m_exit_price').textContent = parseFloat(t.exit_price).toFixed(2);
      document.getElementById('m_setup').textContent = t.setup || '-';
      document.getElementById('m_score').textContent = t.score || t['Total Score'] || '-';

      // 4. Process Tags (New Columns)
      // Helper to style the tags based on content
      const setTag = (id, val) => {
        const el = document.getElementById(id);
        el.textContent = val || '-';
        el.className = 'process-tag ' + (
          !val ? 'tag-gray' :
          val.toLowerCase().includes('follow') || val.toLowerCase().includes('complete') ? 'tag-green' :
          val.toLowerCase().includes('no') || val.toLowerCase().includes('fail') || val.toLowerCase().includes('impulse') ? 'tag-red' :
          'tag-gray'
        );
      };

      setTag('m_tag_pre', t.pre_trade);
      setTag('m_tag_entry', t.trade_entry);
      setTag('m_tag_mgmt', t.trade_management);
      setTag('m_tag_exit', t.trade_exit);

      // 5. Notes
      document.getElementById('m_notes').textContent = t.notes || 'No detailed notes logged for this trade.';
    }

    // ‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const res = await fetch(DATA_URL);
        if(!res.ok) throw new Error();
        const data = await res.json();
        
        // Data Normalization
        rawData = { ...data, 
          trades: (data.trades||[]).slice().reverse(), // Newest first
          symbols: data.symbols||{}, calendar: data.calendar||{}
        };
        
        // Sort for Balance Calc
        const sorted = [...rawData.trades].sort((a,b) => new Date(a.date+' '+a.entry_time) - new Date(b.date+' '+b.entry_time));
        
        // Calculate Equity
        const eqT = [{trade:0, equity:50000, date:'Start'}];
        let bal = 50000;
        sorted.forEach((t,i) => {
          bal += getNetPnL(t);
          eqT.push({trade:i+1, equity:bal, date:t.date, pnl:getNetPnL(t)});
        });
        rawData.equityTrades = eqT;

        // Calculate Equity Days
        const dMap = new Map();
        sorted.forEach(t => dMap.set(t.date, (dMap.get(t.date)||0) + getNetPnL(t)));
        const eqD = [{day:0, equity:50000, date:'Start'}];
        bal = 50000;
        Array.from(dMap.entries()).sort((a,b)=>new Date(a[0])-new Date(b[0])).forEach((e,i) => {
          bal += e[1];
          eqD.push({day:i+1, equity:bal, date:e[0], pnl:e[1]});
        });
        rawData.equityDays = eqD;

        allTrades = rawData.trades;
        filteredTrades = [...allTrades];
        
        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('mainDashboard').classList.remove('hidden');
        initDashboard();
      } catch(e) {
        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('errorState').classList.remove('hidden');
      }
    });

    function initDashboard() {
      document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
      buildMetrics(); buildSymbolPerformance(); buildEvaluationPanel(); buildInsights();
      initCharts(); renderCalendar(); displayTrades();
    }

    // ‚ïê‚ïê‚ïê‚ïê COMPONENTS ‚ïê‚ïê‚ïê‚ïê
    function buildMetrics() {
      const t = rawData.trades;
      const net = t.reduce((s,x)=>s+getNetPnL(x),0);
      const wins = t.filter(x=>parseMoneyValue(x.p_l)>0);
      const losses = t.filter(x=>parseMoneyValue(x.p_l)<0);
      const wr = t.length ? (wins.length/t.length)*100 : 0;
      const pf = losses.length ? wins.reduce((s,x)=>s+parseMoneyValue(x.p_l),0)/Math.abs(losses.reduce((s,x)=>s+parseMoneyValue(x.p_l),0)) : 0;
      
      const bal = rawData.equityTrades[rawData.equityTrades.length-1].equity;

      const items = [
        { l:'Net Return', v:formatMoney(net), c:net>=0?'text-green-400':'text-red-400' },
        { l:'Win Rate', v:wr.toFixed(2)+'%', c:wr>=50?'text-green-400':'text-red-400', visual:true, p:wr },
        { l:'Avg P&L', v:formatMoney(t.length?net/t.length:0), c:net>=0?'text-green-400':'text-red-400' },
        { l:'Profit Factor', v:pf.toFixed(2), c:pf>=1?'text-green-400':'text-red-400' },
        { l:'Account Balance', v:'$'+bal.toFixed(2), c:'text-white', sub: `${net>=0?'‚Üë':'‚Üì'} ${((net/50000)*100).toFixed(1)}%` }
      ];

      document.getElementById('metricsContainer').innerHTML = items.map(i => `
        <div class="metric-card p-4 rounded-lg border border-[#2a2a2a]">
          <p class="text-gray-400 text-xs mb-1">${i.l}</p>
          ${i.visual ? `
            <div class="flex items-center justify-between">
              <p class="text-xl font-bold ${i.c}">${i.v}</p>
              <div class="w-10 h-10 relative">
                <svg class="w-10 h-10 -rotate-90"><circle cx="20" cy="20" r="16" stroke="#333" stroke-width="3" fill="none"/><circle cx="20" cy="20" r="16" stroke="${i.p>=50?'#10b981':'#ef4444'}" stroke-width="3" fill="none" stroke-dasharray="${100*i.p/100} 100"/></svg>
              </div>
            </div>` : 
            `<p class="text-xl font-bold ${i.c}">${i.v}</p>`}
          ${i.sub ? `<p class="text-xs text-gray-500 mt-1">${i.sub}</p>` : ''}
        </div>`).join('');
    }

    // (Kept other render functions concise for brevity, logic matches previous working version)
    function buildSymbolPerformance() {
      const s = Object.entries(rawData.symbols).sort((a,b)=>b[1].pnl-a[1].pnl).slice(0,5);
      document.getElementById('symbolPerformance').innerHTML = s.map(([k,v])=>`<div class="flex justify-between p-3 bg-[#0a0a0a] rounded"><span class="font-medium">${k}</span><div class="text-right"><span class="${v.pnl>=0?'text-green-400':'text-red-400'}">${formatMoney(v.pnl)}</span><span class="text-xs text-gray-500 ml-2">${((v.wins/v.trades)*100).toFixed(0)}% WR</span></div></div>`).join('');
    }

    function buildEvaluationPanel() {
      const t = rawData.trades;
      const dPnL = {}; t.forEach(x=>dPnL[x.date]=(dPnL[x.date]||0)+getNetPnL(x));
      const wD = Object.values(dPnL).filter(x=>x>0).length;
      const lD = Object.values(dPnL).filter(x=>x<0).length;
      const dd = Math.max(...rawData.equityTrades.map(x=>x.pnl*-1), 0); // Simplified visual logic
      
      let streak=0, type='';
      for(let i=0; i<t.length; i++) { // From newest (index 0)
        const w = parseMoneyValue(t[i].p_l)>0;
        if(i===0) type=w?'W':'L';
        if((type==='W'&&w)||(type==='L'&&!w)) streak++; else break;
      }

      const list = [
        {l:'Total Trades',v:t.length}, {l:'Win/Loss Days',v:`${wD}/${lD}`},
        {l:'Current Streak',v:`${type}${streak}`, c:'text-gray-300'}
      ];
      document.getElementById('evaluationPanel').innerHTML = list.map(x=>`<div class="flex justify-between border-b border-[#222] py-2 last:border-0"><span class="text-gray-400 text-sm">${x.l}</span><span class="font-medium ${x.c||''}">${x.v}</span></div>`).join('');
    }

    function buildInsights() {
      const i = rawData.insights || [];
      if(i.length) document.getElementById('insightsContainer').innerHTML = `<div class="bg-[#1a1a1a] p-4 rounded border border-[#2a2a2a]"><h3 class="font-bold mb-2">Insights</h3><div class="grid gap-2">${i.map(x=>`<div class="bg-[#111] p-2 text-sm text-gray-300 rounded">${x}</div>`).join('')}</div></div>`;
    }

    // ‚ïê‚ïê‚ïê‚ïê CALENDAR & TABLE ‚ïê‚ïê‚ïê‚ïê
    let calYear = new Date().getFullYear(), calMonth = new Date().getMonth();
    
    function renderCalendar() {
      const mNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      document.getElementById('calendarMonthYear').textContent = `${mNames[calMonth]} ${calYear}`;
      
      const first = new Date(calYear, calMonth, 1).getDay();
      const days = new Date(calYear, calMonth+1, 0).getDate();
      const offset = first===0 ? 6 : first-1;
      
      let h = '';
      for(let i=0; i<offset; i++) h += `<div class="h-16 bg-[#111] border border-[#222]"></div>`;
      
      for(let d=1; d<=days; d++) {
        const dateStr = `${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const dayTrades = rawData.trades.filter(t => t.date === dateStr);
        const dayPnL = dayTrades.reduce((s,t)=>s+parseMoneyValue(t.p_l),0);
        
        let bg = 'bg-[#1a1a1a]', txt = 'text-gray-500';
        if(dayTrades.length) {
          bg = dayPnL>=0 ? 'bg-green-900/20 border-green-900/50' : 'bg-red-900/20 border-red-900/50';
          txt = dayPnL>=0 ? 'text-green-400' : 'text-red-400';
        }

        let tip = '';
        if(dayTrades.length) {
          tip = `<div class="calendar-tooltip"><div class="font-bold border-b border-[#444] mb-1 pb-1">${dateStr}</div>`;
          dayTrades.forEach(t => {
            tip += `<div onclick="event.stopPropagation(); openTradeModal('${t.trade_id}')" class="flex justify-between hover:bg-[#333] p-1 cursor-pointer rounded"><span>${t.symbol}</span><span class="${parseMoneyValue(t.p_l)>=0?'text-green-400':'text-red-400'}">${formatMoney(t.p_l)}</span></div>`;
          });
          tip += `</div>`;
        }

        h += `<div class="calendar-day h-16 border border-[#2a2a2a] ${bg} flex flex-col items-center justify-center relative">
          <span class="text-sm font-bold text-gray-400">${d}</span>
          ${dayTrades.length ? `<span class="text-xs ${txt}">${formatMoney(dayPnL)}</span>` : ''}
          ${tip}
        </div>`;
      }
      document.getElementById('calendarGrid').innerHTML = h;
    }

    window.changeCalendarMonth = (d) => {
      calMonth += d;
      if(calMonth>11) { calMonth=0; calYear++; }
      if(calMonth<0) { calMonth=11; calYear--; }
      renderCalendar();
    }

    function displayTrades(page=1) {
      const start = (page-1)*tradesPerPage;
      const sub = filteredTrades.slice(start, start+tradesPerPage);
      
      document.getElementById('tradesTableBody').innerHTML = sub.map(t => {
        const {thumb, full} = driveUrls(t.screenshot || t.screenshot_url_A);
        const pnl = parseMoneyValue(t.p_l);
        return `<tr class="trade-row border-b border-[#222]" onclick="openTradeModal('${t.trade_id}')">
          <td class="py-3 px-4 text-blue-400 font-mono text-sm">${t.trade_id}</td>
          <td class="py-3 px-4 text-gray-400 text-sm">${t.date}</td>
          <td class="py-3 px-4 font-bold text-sm">${t.symbol}</td>
          <td class="py-3 px-4 hide-mobile"><span class="px-2 py-1 text-xs font-bold rounded ${t.side==='Long'?'bg-green-900 text-green-200':'bg-red-900 text-red-200'}">${t.side}</span></td>
          <td class="py-3 px-4 hide-mobile text-sm font-mono text-gray-400">${parseFloat(t.entry_price).toFixed(2)}</td>
          <td class="py-3 px-4 hide-mobile text-sm font-mono text-gray-400">${parseFloat(t.exit_price).toFixed(2)}</td>
          <td class="py-3 px-4 text-right font-bold text-sm ${pnl>=0?'text-green-400':'text-red-400'}">${formatMoney(pnl)}</td>
          <td class="py-3 px-4 text-center" onclick="event.stopPropagation()">
            ${full ? `<a href="${full}" target="_blank" class="text-xs bg-[#333] px-2 py-1 rounded hover:bg-white hover:text-black transition-colors">IMG</a>` : '<span class="text-gray-600">-</span>'}
          </td>
        </tr>`;
      }).join('');
      
      document.getElementById('paginationInfo').textContent = `${start+1}-${Math.min(start+tradesPerPage, filteredTrades.length)} / ${filteredTrades.length}`;
      currentPage = page;
    }

    window.changePage = (d) => {
      const max = Math.ceil(filteredTrades.length/tradesPerPage);
      if(currentPage+d >= 1 && currentPage+d <= max) displayTrades(currentPage+d);
    }

    window.filterTrades = () => {
      const q = document.getElementById('tradeSearch').value.toLowerCase();
      const type = document.getElementById('tradeFilter').value;
      filteredTrades = allTrades.filter(t => {
        const mQ = t.symbol.toLowerCase().includes(q) || t.notes?.toLowerCase().includes(q);
        const pnl = parseMoneyValue(t.p_l);
        const mType = type===''?true : type==='win'?pnl>0 : pnl<0;
        return mQ && mType;
      });
      displayTrades(1);
    }

    function initCharts() {
      Chart.defaults.color='#666'; Chart.defaults.borderColor='#333';
      equityChart = new Chart(document.getElementById('equityChart'), {
        type: 'line',
        data: { labels:[], datasets:[{label:'Equity', data:[], borderColor:'#10b981', backgroundColor:'rgba(16,185,129,0.1)', fill:true, tension:0.4}] },
        options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}} }
      });
      switchEquityView('trades');

      // Simple Time Chart
      const hData = Object.entries(rawData.hours).sort((a,b)=>parseInt(a[0])-parseInt(b[0]));
      new Chart(document.getElementById('timeAnalysisChart'), {
        type: 'bar',
        data: { labels: hData.map(x=>x[0]+':00'), datasets:[{data:hData.map(x=>x[1].pnl), backgroundColor: hData.map(x=>x[1].pnl>=0?'#10b981':'#ef4444')}] },
        options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
      });
      
      // Simple Symbol Chart
      const sData = Object.entries(rawData.symbols).sort((a,b)=>b[1].pnl-a[1].pnl).slice(0,10);
      new Chart(document.getElementById('symbolChart'), {
        type: 'bar',
        data: { labels: sData.map(x=>x[0]), datasets:[{data:sData.map(x=>x[1].pnl), backgroundColor: sData.map(x=>x[1].pnl>=0?'#10b981':'#ef4444')}] },
        options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, indexAxis:'y' }
      });

      // Simple Weekday Chart
      const wDays = ['Monday','Tuesday','Wednesday','Thursday','Friday'];
      new Chart(document.getElementById('weekdayChart'), {
        type: 'bar',
        data: { labels: wDays, datasets:[{data: wDays.map(d=>(rawData.weekdays[d]||{}).pnl||0), backgroundColor: wDays.map(d=>(rawData.weekdays[d]||{}).pnl>=0?'#10b981':'#ef4444')}] },
        options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
      });
    }

    window.switchEquityView = (mode) => {
      const d = mode==='days' ? rawData.equityDays : rawData.equityTrades;
      equityChart.data.labels = d.map(x => mode==='days' ? x.date : 'T'+x.trade);
      equityChart.data.datasets[0].data = d.map(x => x.equity);
      equityChart.update();
      document.getElementById('equityByTrades').className = mode==='trades'?'px-3 py-1 text-sm rounded bg-[#2a2a2a]':'px-3 py-1 text-sm rounded bg-[#1a1a1a] text-gray-400';
      document.getElementById('equityByDays').className = mode==='days'?'px-3 py-1 text-sm rounded bg-[#2a2a2a]':'px-3 py-1 text-sm rounded bg-[#1a1a1a] text-gray-400';
    }

    document.addEventListener('keydown', (e) => {
      if(modalOpen) {
        if(e.key==='ArrowLeft') navigateTrade(1); // Newest is index 0, so 'next' logic reversed visually? No, array is reversed. 
        // Actually array is Newest First. So index 0 is newest. Index + 1 is older. 
        // Usually Right Arrow = Forward in time (Newer). Left Arrow = Back in time (Older).
        // Let's stick to list order: Left = Prev index, Right = Next index.
        if(e.key==='ArrowLeft') navigateTrade(-1);
        if(e.key==='ArrowRight') navigateTrade(1);
        if(e.key==='Escape') closeModal();
      }
    });
  </script>
</body>
</html>
