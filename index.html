<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Teila's Trading Terminal</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* ‚ïê‚ïê‚ïê‚ïê THEME VARIABLES ‚ïê‚ïê‚ïê‚ïê */
        :root {
            --bg-deep: #050505;
            --bg-surface: #0a0a0a;
            --border-subtle: #1f1f1f;
            --border-highlight: #333;
            --accent-green: #10b981;
            --accent-red: #f43f5e;
            --glow-green: rgba(16, 185, 129, 0.2);
            --glow-red: rgba(244, 63, 94, 0.2);
        }

        body { 
            margin: 0; 
            background-color: var(--bg-deep); 
            background-image: radial-gradient(circle at 50% 0%, #1a1a1a 0%, #050505 60%);
            background-attachment: fixed;
            color: #e5e7eb; 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
        }

        /* Typography Utilities */
        .font-mono { font-family: 'JetBrains Mono', monospace; letter-spacing: -0.5px; }
        .text-glow-green { text-shadow: 0 0 10px var(--glow-green); }
        .text-glow-red { text-shadow: 0 0 10px var(--glow-red); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-deep); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        /* ‚ïê‚ïê‚ïê‚ïê COMPONENT STYLING ‚ïê‚ïê‚ïê‚ïê */
        
        /* Tech Card (Enhanced with Spotlight) */
        .tech-card {
            background: radial-gradient(
                800px circle at var(--mouse-x, 50%) var(--mouse-y, 50%), 
                rgba(255, 255, 255, 0.04), 
                transparent 40%
            ), linear-gradient(180deg, #111 0%, #0a0a0a 100%);
            border: 1px solid var(--border-subtle);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            z-index: 1;
        }

        /* Glowing Border Effect */
        .tech-card::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            border-radius: inherit;
            padding: 1px;
            background: radial-gradient(
                600px circle at var(--mouse-x, 50%) var(--mouse-y, 50%), 
                rgba(255, 255, 255, 0.3), 
                transparent 40%
            );
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
            z-index: 2;
        }

        .tech-card:hover::before { opacity: 1; }
        .tech-card:hover { transform: translateY(-2px); box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.5); }

        /* Charts */
        .chart-container-lg { height: 280px; width: 100%; position: relative; }
        @media (min-width: 768px) { .chart-container-lg { height: 380px; } }

        /* Calendar */
        .calendar-grid-8 { display: grid; grid-template-columns: repeat(8, minmax(0, 1fr)); gap: 6px; min-width: 800px; }
        .calendar-scroll-wrapper { overflow-x: auto; padding-bottom: 12px; }

        .calendar-day { 
            position: relative; 
            background: #0e0e0e;
            border: 1px solid #1a1a1a;
            border-radius: 6px;
            transition: all 0.2s ease;
            min-height: 70px;
        }
        @media (min-width: 768px) { .calendar-day { min-height: 90px; } }
        
        .calendar-day.has-trades:hover { 
            transform: scale(1.05); 
            border-color: #555; 
            z-index: 10; 
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
            cursor: pointer;
        }
        .current-day { border: 1px solid #3b82f6; box-shadow: 0 0 15px rgba(59, 130, 246, 0.15); }
        
        /* Table */
        .trade-row { transition: background-color 0.15s; }
        .trade-row:hover { background-color: rgba(255,255,255,0.03); cursor: pointer; }
        .table-header { font-size: 0.7rem; letter-spacing: 0.05em; color: #6b7280; font-weight: 600; text-transform: uppercase; }

        /* Badges */
        .badge { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; letter-spacing: 0.025em; text-transform: uppercase; border: 1px solid transparent; }
        .badge-green { background: rgba(16, 185, 129, 0.1); color: #34d399; border-color: rgba(16, 185, 129, 0.2); box-shadow: 0 0 10px rgba(16, 185, 129, 0.05); }
        .badge-red { background: rgba(244, 63, 94, 0.1); color: #fb7185; border-color: rgba(244, 63, 94, 0.2); box-shadow: 0 0 10px rgba(244, 63, 94, 0.05); }
        .badge-gray { background: rgba(255, 255, 255, 0.05); color: #9ca3af; border-color: rgba(255, 255, 255, 0.1); }

        /* Modal Styles */
        .glass-overlay { 
            background-color: rgba(0, 0, 0, 0.85); 
            backdrop-filter: blur(8px); 
            -webkit-backdrop-filter: blur(8px);
        }
        .glass-panel {
            background: #0a0a0a;
            border: 1px solid #222;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
        }

        /* Nav Arrows */
        .nav-arrow { 
            position: absolute; top: 50%; transform: translateY(-50%); 
            width: 48px; height: 48px; 
            border-radius: 12px;
            background: rgba(20,20,20,0.6); 
            border: 1px solid rgba(255,255,255,0.1); 
            color: #fff; display: flex; align-items: center; justify-content: center; 
            cursor: pointer; transition: all 0.2s; z-index: 60; 
            backdrop-filter: blur(4px);
        }
        .nav-arrow:hover { background: var(--accent-green); border-color: var(--accent-green); box-shadow: 0 0 15px var(--glow-green); }
        .nav-arrow.left { left: 24px; }
        .nav-arrow.right { right: 24px; }

        /* Markdown Styling */
        .prose-custom h1, .prose-custom h2, .prose-custom h3 { color: #fff; font-weight: 700; margin-top: 1em; margin-bottom: 0.5em; font-family: 'Inter', sans-serif; }
        .prose-custom p { margin-bottom: 0.8em; color: #9ca3af; line-height: 1.6; font-size: 0.95rem; }
        .prose-custom ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.8em; color: #9ca3af; }
        .prose-custom strong { color: #e5e7eb; font-weight: 600; }

        /* Button Styling */
        .btn-tech { 
            background: #1a1a1a; 
            border: 1px solid #333; 
            padding: 6px 16px; 
            border-radius: 6px; 
            font-size: 0.8rem; 
            font-weight: 500; 
            transition: all 0.2s; 
            color: #d1d5db;
        }
        .btn-tech:hover:not(:disabled) { background: #252525; border-color: #555; color: #fff; }
        .btn-tech.active { background: #222; border-color: var(--accent-green); color: var(--accent-green); box-shadow: 0 0 10px rgba(16, 185, 129, 0.1); }
        .btn-tech:disabled { opacity: 0.5; cursor: not-allowed; }

        /* ‚ïê‚ïê‚ïê‚ïê ANIMATIONS ‚ïê‚ïê‚ïê‚ïê */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-enter {
            opacity: 0; /* Hidden by default */
            animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* Mobile Overrides */
        @media (max-width: 1024px) {
            .nav-arrow { bottom: 20px; top: auto; transform: none; }
            .nav-arrow.left { left: 20px; }
            .nav-arrow.right { right: 20px; }
            .hide-mobile { display: none; }
            table { min-width: 650px; }
            .glass-panel {
                width: 100% !important; height: 100% !important;
                max-width: 100% !important; max-height: 100% !important;
                border-radius: 0 !important; border: none !important;
            }
        }
    </style>
</head>
<body class="overflow-x-hidden selection:bg-green-500 selection:text-white">

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DAY LIST MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="dayModal" class="hidden fixed inset-0 z-[990] glass-overlay flex items-center justify-center lg:p-4" onclick="closeModal('dayModal')">
        <div onclick="event.stopPropagation()" class="glass-panel w-full lg:max-w-md lg:rounded-2xl overflow-hidden relative z-[991] flex flex-col lg:max-h-[70vh]">
            <div class="flex justify-between items-center px-5 py-4 border-b border-[#222] bg-[#111]">
                <div>
                    <h2 id="d_date" class="text-lg font-bold text-white leading-tight font-mono tracking-tight">--</h2>
                    <div id="d_pnl" class="text-sm font-bold mt-1 font-mono">--</div>
                </div>
                <button onclick="closeModal('dayModal')" class="bg-[#222] text-gray-400 hover:text-white w-8 h-8 rounded-full flex items-center justify-center transition-colors border border-[#333]">&times;</button>
            </div>
            <div id="d_tradeList" class="p-2 overflow-y-auto space-y-1 flex-1 bg-[#050505]/50"></div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TRADE DETAILS MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="tradeModal" class="hidden fixed inset-0 z-[1000] glass-overlay flex flex-col items-center justify-center lg:p-6" onclick="closeModal('tradeModal')">
        <button onclick="event.stopPropagation(); navigateTrade(-1)" class="nav-arrow left hidden lg:flex">‚ùÆ</button>
        <button onclick="event.stopPropagation(); navigateTrade(1)" class="nav-arrow right hidden lg:flex">‚ùØ</button>

        <div onclick="event.stopPropagation()" class="glass-panel w-full lg:max-w-[1400px] h-full lg:h-[90vh] lg:rounded-2xl overflow-hidden flex flex-col relative z-[1001]">
            <!-- Header (Sticky on Mobile) -->
            <div class="sticky top-0 z-50 flex justify-between items-center px-6 py-4 lg:px-8 lg:py-5 border-b border-[#222] bg-[#0f0f0f] backdrop-blur-md">
                <div class="flex items-center gap-4 lg:gap-8">
                    <div>
                        <h2 id="m_tradeId" class="text-2xl lg:text-3xl font-bold font-mono text-white tracking-tight">--</h2>
                        <div class="flex items-center gap-2 text-xs text-gray-500 mt-1 font-mono uppercase tracking-wide">
                            <span id="m_date">--</span> <span class="text-gray-700">‚Ä¢</span> <span id="m_time">--</span>
                        </div>
                    </div>
                    
                    <!-- Desktop Only Stats in Header -->
                    <div class="hidden lg:flex items-center gap-8">
                        <div class="h-10 w-px bg-[#333]"></div>
                        <div>
                            <span class="text-[10px] uppercase text-gray-500 font-bold tracking-widest">Result</span>
                            <div id="m_pnl" class="text-3xl font-bold leading-none mt-1 font-mono">--</div>
                        </div>
                    </div>
                </div>
                
                <!-- Close Button -->
                <button onclick="closeModal('tradeModal')" class="bg-[#1a1a1a] text-gray-400 hover:text-white w-10 h-10 rounded-full flex items-center justify-center border border-[#333] transition-all hover:bg-red-500/20 hover:border-red-500/50 hover:text-red-500 text-xl leading-none">&times;</button>
            </div>

            <div class="flex-1 overflow-hidden flex flex-col lg:flex-row">
                <!-- Image Area -->
                <div class="w-full lg:w-3/4 h-[40vh] lg:h-full bg-[#050505] flex items-center justify-center border-b border-[#222] lg:border-b-0 lg:border-r relative group">
                    <img id="m_image" src="" class="max-w-full max-h-full object-contain" alt="Chart">
                    <div id="m_no_image" class="hidden flex flex-col items-center text-gray-700"><span class="text-6xl mb-4 opacity-20">üì∑</span><span class="font-mono text-sm uppercase tracking-widest">No Screenshot</span></div>
                    
                    <!-- Open Original Button -->
                    <a id="m_full_link" href="#" target="_blank" class="absolute top-4 right-4 bg-black/40 hover:bg-black/80 text-gray-300 hover:text-white border border-white/10 hover:border-white/30 px-3 py-1.5 rounded-full text-[10px] font-bold tracking-wider uppercase transition-all backdrop-blur-sm flex items-center gap-2">
                        <span>Original</span> ‚Üó
                    </a>
                </div>

                <!-- Data Area -->
                <div class="w-full lg:w-1/4 h-[60vh] lg:h-full bg-[#0a0a0a] overflow-y-auto flex flex-col divide-y divide-[#222] pb-20 lg:pb-0">
                    <!-- Mobile Stats (Visible only on Mobile) -->
                    <div class="lg:hidden p-5 bg-[#111] border-b border-[#222] flex justify-between items-center">
                        <div>
                            <span class="text-[10px] text-gray-500 uppercase font-bold tracking-widest">Net P&L</span>
                            <div id="m_pnl_mob" class="text-2xl font-bold font-mono">--</div>
                        </div>
                        <div class="text-right">
                            <span id="m_symbol" class="text-xs font-bold font-mono text-gray-300 bg-[#222] border border-[#333] px-2 py-1 rounded">--</span>
                            <div id="m_side" class="text-[10px] font-bold uppercase tracking-wide mt-1">--</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 bg-[#0c0c0c]">
                        <div class="p-5 border-r border-[#222]"><span class="text-[10px] uppercase text-gray-500 font-bold tracking-wider">Entry Price</span><div id="m_entry_price" class="text-lg font-mono text-white mt-1">--</div></div>
                        <div class="p-5"><span class="text-[10px] uppercase text-gray-500 font-bold tracking-wider">Exit Price</span><div id="m_exit_price" class="text-lg font-mono text-white mt-1">--</div></div>
                    </div>

                    <div class="p-6 space-y-4">
                        <div class="flex justify-between items-center"><span class="text-sm text-gray-500 font-medium">Setup</span><span id="m_setup" class="text-sm text-white font-mono">--</span></div>
                        <div class="flex justify-between items-center"><span class="text-sm text-gray-500 font-medium">Session</span><span id="m_session" class="text-sm text-white font-mono">--</span></div>
                        <div class="flex justify-between items-center"><span class="text-sm text-gray-500 font-medium">Score</span><span id="m_score" class="text-sm font-bold text-yellow-400 font-mono">--</span></div>
                        <div class="flex justify-between items-center"><span class="text-sm text-gray-500 font-medium">Fees</span><span id="m_fees" class="text-sm text-red-400 font-mono opacity-80">--</span></div>
                    </div>

                    <div class="p-6 space-y-4 bg-[#0e0e0e]">
                        <h3 class="text-[10px] uppercase text-gray-500 font-bold tracking-widest mb-3">Execution Process</h3>
                        <div class="flex justify-between items-center"><span class="text-sm text-gray-400">Pre-Trade</span><span id="m_tag_pre" class="badge">--</span></div>
                        <div class="flex justify-between items-center"><span class="text-sm text-gray-400">Entry</span><span id="m_tag_entry" class="badge">--</span></div>
                        <div class="flex justify-between items-center"><span class="text-sm text-gray-400">Management</span><span id="m_tag_mgmt" class="badge">--</span></div>
                        <div class="flex justify-between items-center"><span class="text-sm text-gray-400">Exit</span><span id="m_tag_exit" class="badge">--</span></div>
                    </div>

                    <div class="p-6 flex-1 bg-[#0a0a0a]">
                        <h3 class="text-[10px] uppercase text-gray-500 font-bold tracking-widest mb-4">Journal Notes</h3>
                        <div class="bg-[#111] p-4 rounded-lg border border-[#222] min-h-[120px]"><p id="m_notes" class="text-sm text-gray-300 leading-relaxed whitespace-pre-wrap font-sans">--</p></div>
                    </div>
                </div>
            </div>
            
            <!-- Mobile Navigation -->
            <div class="lg:hidden absolute bottom-6 left-0 right-0 flex justify-center gap-4 z-50 pointer-events-none">
                <button onclick="event.stopPropagation(); navigateTrade(-1)" class="pointer-events-auto bg-[#1a1a1a] border border-[#333] w-14 h-14 rounded-full text-white flex items-center justify-center shadow-xl text-xl backdrop-blur-md">‚ùÆ</button>
                <button onclick="event.stopPropagation(); navigateTrade(1)" class="pointer-events-auto bg-[#1a1a1a] border border-[#333] w-14 h-14 rounded-full text-white flex items-center justify-center shadow-xl text-xl backdrop-blur-md">‚ùØ</button>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê REVIEW MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="reviewModal" class="hidden fixed inset-0 z-[1000] glass-overlay flex flex-col items-center justify-center lg:p-6" onclick="closeModal('reviewModal')">
        <button onclick="event.stopPropagation(); navigateReview(-1)" class="nav-arrow left hidden lg:flex">‚ùÆ</button>
        <button onclick="event.stopPropagation(); navigateReview(1)" class="nav-arrow right hidden lg:flex">‚ùØ</button>

        <div onclick="event.stopPropagation()" class="glass-panel w-full lg:max-w-[1200px] h-full lg:h-[85vh] lg:rounded-2xl overflow-hidden flex flex-col shadow-2xl relative z-[1001]">
            <!-- Header (Sticky) -->
            <div class="sticky top-0 z-50 flex justify-between items-center px-6 py-4 lg:px-8 lg:py-5 border-b border-[#222] bg-[#0f0f0f] backdrop-blur-md">
                <div>
                    <span id="r_type" class="text-[10px] font-bold text-blue-400 uppercase tracking-widest border border-blue-900/40 bg-blue-500/10 px-2 py-1 rounded">--</span>
                    <h2 id="r_date" class="text-2xl lg:text-3xl font-bold text-white mt-2 font-mono tracking-tight">--</h2>
                </div>
                <!-- Close Button -->
                <button onclick="closeModal('reviewModal')" class="bg-[#1a1a1a] text-gray-400 hover:text-white w-10 h-10 rounded-full flex items-center justify-center border border-[#333] transition-all hover:bg-red-500/20 hover:border-red-500/50 hover:text-red-500 text-xl leading-none">&times;</button>
            </div>

            <!-- Stats Bar -->
            <div class="grid grid-cols-2 md:grid-cols-4 border-b border-[#222] bg-[#111]">
                <div class="p-5 border-r border-[#222]">
                    <span class="text-[10px] uppercase text-gray-500 font-bold tracking-widest">Net P&L</span>
                    <div id="r_pnl" class="text-2xl font-bold text-white mt-1 font-mono">--</div>
                </div>
                <div class="p-5 border-r border-[#222]">
                    <span class="text-[10px] uppercase text-gray-500 font-bold tracking-widest">Win Rate</span>
                    <div id="r_wr" class="text-2xl font-bold text-white mt-1 font-mono">--</div>
                </div>
                <div class="p-5 border-r border-[#222]">
                    <span class="text-[10px] uppercase text-gray-500 font-bold tracking-widest">Avg Score</span>
                    <div id="r_score" class="text-2xl font-bold text-yellow-400 mt-1 font-mono">--</div>
                </div>
                <div class="p-5">
                    <span class="text-[10px] uppercase text-gray-500 font-bold tracking-widest">Cost of Errors</span>
                    <div id="r_cost" class="text-2xl font-bold text-red-400 mt-1 font-mono">--</div>
                </div>
            </div>

            <div class="flex-1 overflow-hidden flex flex-col lg:flex-row bg-[#0a0a0a]">
                <!-- AI Insight -->
                <div class="w-full lg:w-1/2 p-6 lg:p-8 overflow-y-auto border-b lg:border-b-0 lg:border-r border-[#222]">
                    <div class="flex items-center gap-3 mb-6 pb-4 border-b border-[#222]">
                        <span class="text-2xl">ü§ñ</span>
                        <h3 class="text-sm font-bold uppercase tracking-widest text-gray-400">Mentor Insight</h3>
                    </div>
                    <div id="r_ai_insight" class="prose-custom">--</div>
                </div>
                <!-- User Reflection -->
                <div class="w-full lg:w-1/2 p-6 lg:p-8 overflow-y-auto bg-[#0d0d0d]">
                    <div class="flex items-center gap-3 mb-6 pb-4 border-b border-[#222]">
                        <span class="text-2xl">üß†</span>
                        <h3 class="text-sm font-bold uppercase tracking-widest text-gray-400">Personal Reflection</h3>
                    </div>
                    <div id="r_reflection" class="prose-custom whitespace-pre-wrap">--</div>
                </div>
            </div>

            <!-- Mobile Nav -->
            <div class="lg:hidden absolute bottom-6 left-0 right-0 flex justify-center gap-4 z-50 pointer-events-none">
                <button onclick="event.stopPropagation(); navigateReview(-1)" class="pointer-events-auto bg-[#1a1a1a] border border-[#333] w-14 h-14 rounded-full text-white flex items-center justify-center shadow-xl text-xl backdrop-blur-md">‚ùÆ</button>
                <button onclick="event.stopPropagation(); navigateReview(1)" class="pointer-events-auto bg-[#1a1a1a] border border-[#333] w-14 h-14 rounded-full text-white flex items-center justify-center shadow-xl text-xl backdrop-blur-md">‚ùØ</button>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="loadingState" class="fixed inset-0 bg-[#050505] flex items-center justify-center z-50">
        <div class="text-center">
            <div class="w-10 h-10 border-4 border-[#333] border-t-green-500 rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-gray-500 font-mono text-sm tracking-widest">INITIALIZING TERMINAL...</p>
        </div>
    </div>
    
    <div id="errorState" class="hidden fixed inset-0 bg-[#050505] flex items-center justify-center z-50">
        <div class="text-center text-red-500 p-6 tech-card rounded-xl">
            <h2 class="text-xl font-bold mb-2 font-mono">CONNECTION ERROR</h2>
            <p id="errorDetail" class="text-sm text-gray-400 mb-4"></p>
            <button onclick="location.reload()" class="btn-tech">RETRY CONNECTION</button>
        </div>
    </div>

    <div id="mainDashboard" class="hidden min-h-screen p-4 md:p-8 max-w-[1800px] mx-auto" onmousemove="">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-10 gap-4">
            <div class="animate-enter delay-1">
                <h1 class="text-3xl md:text-4xl font-bold flex items-center tracking-tight text-white">
                    Trading Terminal <span class="w-3 h-3 bg-green-500 rounded-full ml-4 shadow-[0_0_15px_rgba(16,185,129,0.6)] animate-pulse"></span>
                </h1>
                <p class="text-sm text-gray-500 mt-2 font-mono">LIVE PERFORMANCE TRACKING ‚Ä¢ <span id="lastUpdated" class="text-gray-400">--</span></p>
            </div>
        </div>

        <!-- Metrics -->
        <div id="metricsContainer" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8"></div>

        <!-- Equity -->
        <div class="tech-card rounded-xl p-6 md:p-8 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-semibold tracking-wide text-gray-200">Net Equity Curve</h2>
                <div class="flex space-x-1 bg-[#1a1a1a] p-1 rounded-lg border border-[#333]">
                    <button id="equityByTrades" class="btn-tech active" onclick="switchEquityView('trades')">Trades</button>
                    <button id="equityByDays" class="btn-tech" onclick="switchEquityView('days')">Days</button>
                </div>
            </div>
            <div class="chart-container-lg"><canvas id="equityChart"></canvas></div>
        </div>

        <!-- Calendar & Evaluation -->
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mb-8">
            <!-- Calendar Panel -->
            <div class="xl:col-span-2 tech-card rounded-xl p-6 md:p-8">
                <div class="flex justify-between items-center mb-8">
                    <button onclick="changeCalendarMonth(-1)" class="w-8 h-8 flex items-center justify-center hover:bg-[#222] rounded text-gray-400 hover:text-white transition-colors">‚ùÆ</button>
                    <h2 id="calendarMonthYear" class="text-xl font-bold tracking-wide text-white"></h2>
                    <button onclick="changeCalendarMonth(1)" class="w-8 h-8 flex items-center justify-center hover:bg-[#222] rounded text-gray-400 hover:text-white transition-colors">‚ùØ</button>
                </div>
                <div class="calendar-scroll-wrapper">
                    <div class="calendar-grid-8 mb-3 text-center text-[10px] md:text-[11px] text-gray-500 font-bold uppercase tracking-widest">
                        <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div><div class="text-gray-300">Total</div>
                    </div>
                    <div id="calendarGrid" class="calendar-grid-8"></div>
                </div>
            </div>

            <!-- Evaluation Panel -->
            <div class="tech-card rounded-xl p-6 md:p-8">
                <h2 class="text-lg font-semibold mb-6 tracking-wide text-gray-200">Evaluation Matrix</h2>
                <div id="evaluationPanel" class="divide-y divide-[#1a1a1a]"></div>
            </div>
        </div>

        <!-- Analysis Panels -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="tech-card rounded-xl p-6 flex flex-col min-h-[350px]">
                <h2 class="text-sm font-bold uppercase tracking-widest text-gray-500 mb-6">Performance By Symbol</h2>
                <div id="symbolPerformance" class="space-y-3 mb-4 overflow-y-auto flex-1 pr-2"></div>
            </div>
            <div class="tech-card rounded-xl p-6 flex flex-col min-h-[350px]">
                <h2 class="text-sm font-bold uppercase tracking-widest text-gray-500 mb-6">Hourly Distribution</h2>
                <div class="relative flex-1 w-full h-64 lg:h-auto"><canvas id="timeAnalysisChart"></canvas></div>
            </div>
            <div class="tech-card rounded-xl p-6 flex flex-col min-h-[350px]">
                <h2 class="text-sm font-bold uppercase tracking-widest text-gray-500 mb-6">Daily Performance</h2>
                <div class="relative flex-1 w-full h-64 lg:h-auto"><canvas id="weekdayChart"></canvas></div>
            </div>
        </div>

        <!-- Performance Reviews Panel -->
        <div class="tech-card rounded-xl p-6 md:p-8 mb-8">
            <h2 class="text-lg font-semibold mb-6 flex items-center gap-3">
                <span class="text-xl">üß†</span> Agent Reviews
            </h2>
            <div class="flex gap-5 overflow-x-auto pb-4" id="reviewsContainer">
                <div class="text-gray-500 font-mono text-sm">No reviews logged in system.</div>
            </div>
        </div>

        <!-- Latest Trade -->
        <div id="lastTradeWidget" class="hidden tech-card rounded-xl mb-8 overflow-hidden group cursor-pointer hover:border-[#444]" onclick="openLastTrade()">
            <div class="flex flex-col md:flex-row h-auto md:h-[350px]">
                <div class="w-full md:w-3/4 bg-[#080808] relative flex items-center justify-center border-b md:border-b-0 md:border-r border-[#222] h-64 md:h-full">
                    <img id="lt_image" class="w-full h-full object-contain opacity-80 transition-opacity duration-500 group-hover:opacity-100" src="" alt="Last Trade">
                    <div id="lt_no_image" class="hidden flex flex-col items-center text-gray-700"><span class="text-5xl mb-4 opacity-20">üì∑</span><span class="font-mono text-xs uppercase tracking-widest">No Screenshot</span></div>
                    <div class="absolute top-6 left-6 bg-black/60 backdrop-blur-md px-3 py-1.5 rounded text-[10px] font-bold text-gray-300 border border-white/10 uppercase tracking-widest">Latest Execution</div>
                </div>
                <div class="w-full md:w-1/4 p-8 flex flex-col justify-center bg-gradient-to-b from-[#111] to-[#0a0a0a]">
                    <div class="mb-8 flex md:block justify-between items-center">
                        <div><span class="text-[10px] text-gray-500 uppercase font-bold tracking-widest">Symbol</span><h3 id="lt_symbol" class="text-4xl font-bold text-white mt-2 font-mono tracking-tight">--</h3></div>
                        <span id="lt_side" class="text-[10px] font-bold px-2 py-1 rounded bg-[#222] text-gray-300 inline-block h-fit border border-[#333] uppercase tracking-wide">--</span>
                    </div>
                    <div class="mb-10">
                        <span class="text-[10px] text-gray-500 uppercase font-bold tracking-widest">Net Result</span>
                        <h3 id="lt_pnl" class="text-4xl md:text-5xl font-bold mt-2 font-mono">--</h3>
                        <p id="lt_date" class="text-xs text-gray-500 mt-3 font-mono">--</p>
                    </div>
                    <button onclick="event.stopPropagation(); openLastTrade()" class="w-full py-3 bg-[#1a1a1a] hover:bg-[#252525] border border-[#333] text-gray-200 rounded font-medium transition-all flex items-center justify-center gap-2 group-hover:border-[#555] group-hover:text-white">Full Journal <span class="text-lg leading-none">‚Üí</span></button>
                </div>
            </div>
        </div>

        <!-- Insights -->
        <div id="insightsContainer" class="mb-8"></div>

        <!-- Table -->
        <div class="tech-card rounded-xl p-6 md:p-8">
            <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                <h2 class="text-lg font-semibold w-full md:w-auto tracking-wide text-gray-200">Execution Log</h2>
                <div class="flex gap-2 w-full md:w-auto">
                    <input type="text" id="tradeSearch" placeholder="SEARCH SYMBOL..." class="bg-[#0a0a0a] border border-[#333] rounded px-4 py-2 text-xs font-mono uppercase text-gray-300 w-full md:w-56 focus:border-green-500 focus:outline-none transition-colors" onkeyup="filterTrades()">
                    <select id="tradeFilter" class="bg-[#0a0a0a] border border-[#333] rounded px-4 py-2 text-xs font-mono uppercase text-gray-300 focus:border-green-500 focus:outline-none" onchange="filterTrades()">
                        <option value="">ALL TRADES</option><option value="win">WINS ONLY</option><option value="loss">LOSSES ONLY</option>
                    </select>
                    <div class="flex gap-1 pl-2">
                        <button class="btn-tech" id="prevPage" onclick="changePage(-1)">‚ùÆ</button>
                        <button class="btn-tech" id="nextPage" onclick="changePage(1)">‚ùØ</button>
                    </div>
                </div>
            </div>
            <div class="table-container">
                <table class="w-full text-left">
                    <thead class="bg-[#111] border-b border-[#222]">
                        <tr>
                            <th class="py-4 px-5 table-header">ID</th>
                            <th class="py-4 px-5 table-header">Date</th>
                            <th class="py-4 px-5 table-header">Symbol</th>
                            <th class="py-4 px-5 table-header hide-mobile">Side</th>
                            <th class="py-4 px-5 table-header hide-mobile">Entry</th>
                            <th class="py-4 px-5 table-header hide-mobile">Exit</th>
                            <th class="py-4 px-5 table-header text-right">Net P&L</th>
                            <th class="py-4 px-5 table-header text-right hide-mobile">Balance</th>
                            <th class="py-4 px-5 table-header text-center">Media</th>
                        </tr>
                    </thead>
                    <tbody id="tradesTableBody" class="divide-y divide-[#1a1a1a]"></tbody>
                </table>
            </div>
            <div class="text-xs text-gray-600 mt-6 text-right font-mono" id="paginationInfo"></div>
        </div>
    </div>

    <script>
        // ‚ïê‚ïê‚ïê‚ïê CONFIG ‚ïê‚ïê‚ïê‚ïê
        const DATA_URL = './data.json';
        const STARTING_BALANCE = 50000;

        // ‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê
        let rawData = {}, allTrades = [], filteredTrades = [], allReviews = [];
        let currentPage = 1, tradesPerPage = 15;
        let equityChart, timeChart, symbolChart, weekdayChart;
        let activeModalId = null, currentTradeIndex = -1, currentReviewIndex = -1;

        // ‚ïê‚ïê‚ïê‚ïê UTILS ‚ïê‚ïê‚ïê‚ïê
        const formatMoney = (v) => (parseFloat(v)||0)>=0 ? '+$'+Math.abs(v).toFixed(2) : '-$'+Math.abs(v).toFixed(2);
        const parseMoneyValue = (v) => {
            if(!v)return 0;
            const c=v.toString().replace(/[$,]/g,'');
            return isNaN(parseFloat(c))?0:parseFloat(c);
        };
        const getNetPnL = (t) => parseMoneyValue(t.p_l) - parseMoneyValue(t.fees||0);
        
        const getHoldTime = (t) => {
            if(!t.entry_time || !t.exit_time) return 0;
            const d1 = new Date(`2000-01-01T${t.entry_time}`);
            const d2 = new Date(`2000-01-01T${t.exit_time}`);
            const diffMs = d2 - d1;
            return diffMs > 0 ? Math.floor(diffMs / 60000) : 0;
        };
        const driveUrls = (url) => {
            if(!url) return {thumb:null,full:null};
            let id = null;
            const m1 = url.match(/\/file\/d\/([\w-]+)/);
            const m2 = url.match(/id=([\w-]+)/);
            if(m1) id=m1[1]; else if(m2) id=m2[1];
            if(id) return { thumb: `https://drive.google.com/thumbnail?id=${id}&sz=w400`, full: `https://drive.google.com/thumbnail?id=${id}&sz=w1920` };
            return { thumb:url, full:url };
        };

        // ‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const url = window.location.protocol.startsWith('http') ? `${DATA_URL}?v=${new Date().getTime()}` : DATA_URL;
                const res = await fetch(url);
                if(!res.ok) throw new Error(`HTTP Error: ${res.status}`);
                const data = await res.json();
                if(!data.trades) throw new Error("JSON missing 'trades' array");

                let sorted = [...(data.trades || [])].sort((a,b) => new Date(a.date+' '+a.entry_time) - new Date(b.date+' '+b.entry_time));
                
                let b = STARTING_BALANCE;
                const eqT = [{trade:0, equity:b, date:'Start'}];
                const dMap = new Map();

                sorted = sorted.map((t, i) => {
                    const net = getNetPnL(t);
                    b += net;
                    eqT.push({trade:i+1, equity:b, date:t.date});
                    dMap.set(t.date, (dMap.get(t.date)||0) + net);
                    return { ...t, runningBalance: b };
                });

                allTrades = sorted.reverse();
                filteredTrades = [...allTrades];
                
                allReviews = (data.reviews || []).sort((a,b) => new Date(b.date) - new Date(a.date));

                let db = STARTING_BALANCE;
                const eqD = [{day:0, equity:db, date:'Start'}];
                Array.from(dMap.entries()).sort((a,b)=>new Date(a[0])-new Date(b[0])).forEach((e,i)=>{
                    db+=e[1];
                    eqD.push({day:i+1,equity:db,date:e[0]});
                });

                rawData = { ...data, trades: allTrades, reviews: allReviews, equityTrades: eqT, equityDays: eqD, startingBalance: STARTING_BALANCE };
                recalculateAggregations();

                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('mainDashboard').classList.remove('hidden');
                initDashboard();
            } catch(e) {
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('errorState').classList.remove('hidden');
                document.getElementById('errorDetail').textContent = e.message;
                console.error(e);
            }
        });

        function recalculateAggregations() {
            const sym = {};
            const hrs = {};
            const wkd = {};
            const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];

            allTrades.forEach(t => {
                const net = getNetPnL(t);
                const win = net > 0;
                
                if(!sym[t.symbol]) sym[t.symbol] = {pnl:0, wins:0, trades:0};
                sym[t.symbol].pnl += net;
                sym[t.symbol].trades++;
                if(win) sym[t.symbol].wins++;

                const h = t.entry_time ? t.entry_time.split(':')[0] : '00';
                if(!hrs[h]) hrs[h] = {pnl:0};
                hrs[h].pnl += net;

                const dObj = new Date(t.date);
                const dName = days[dObj.getDay()];
                if(!wkd[dName]) wkd[dName] = {pnl:0};
                wkd[dName].pnl += net;
            });
            
            rawData.symbols = sym;
            rawData.hours = hrs;
            rawData.weekdays = wkd;
        }

        // --- NEW: SPOTLIGHT EFFECT ---
        function initSpotlightEffect() {
            const cards = document.querySelectorAll('.tech-card');
            document.getElementById('mainDashboard').onmousemove = e => {
                for(const card of cards) {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    card.style.setProperty("--mouse-x", `${x}px`);
                    card.style.setProperty("--mouse-y", `${y}px`);
                }
            }
        }

        function initDashboard() {
            document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
            buildMetrics();
            buildSymbolPerformance();
            buildEvaluationPanel();
            renderReviewsPanel();
            buildInsights();
            renderLastTradeWidget();
            initCharts();
            renderCalendar();
            displayTrades();
            
            // ANIMATIONS
            initSpotlightEffect();
            
            const containers = [
                document.getElementById('metricsContainer'),
                document.querySelector('.chart-container-lg')?.parentElement,
                document.querySelector('.calendar-grid-8')?.parentElement?.parentElement,
                document.getElementById('evaluationPanel')?.parentElement,
                document.getElementById('symbolPerformance')?.parentElement,
                document.getElementById('timeAnalysisChart')?.parentElement?.parentElement,
                document.getElementById('weekdayChart')?.parentElement?.parentElement,
                document.getElementById('reviewsContainer')?.parentElement,
                document.getElementById('lastTradeWidget'),
                document.querySelector('.table-container')?.parentElement
            ];
            
            containers.forEach((el, index) => {
                if(el) {
                    el.classList.add('animate-enter');
                    el.style.animationDelay = `${index * 100}ms`;
                }
            });
        }

        // ‚ïê‚ïê‚ïê‚ïê RENDERERS ‚ïê‚ïê‚ïê‚ïê
        function renderReviewsPanel() {
            const container = document.getElementById('reviewsContainer');
            if(allReviews.length === 0) {
                container.innerHTML = '<div class="text-gray-500 font-mono text-sm p-2">No reviews logged in system.</div>';
                return;
            }
            
            container.innerHTML = allReviews.map(r => {
                const pnl = parseMoneyValue(r.net_pl);
                const isWin = pnl >= 0;
                const snippet = r.user_reflection ? (r.user_reflection.substring(0, 60) + '...') : 'No notes.';
                
                return `
                <div onclick="openReviewModal('${r.review_id}')" class="min-w-[280px] bg-[#111] p-5 rounded-lg border border-[#222] hover:border-[#444] cursor-pointer transition-all hover:-translate-y-1 shadow-lg">
                    <div class="flex justify-between items-start mb-3">
                        <span class="text-[10px] uppercase font-bold text-gray-400 bg-[#1a1a1a] px-2 py-1 rounded border border-[#333]">${r.type || 'REVIEW'}</span>
                        <span class="text-xs text-gray-500 font-mono">${r.date}</span>
                    </div>
                    <div class="mb-3">
                        <div class="text-xl font-bold font-mono ${isWin ? 'text-green-400 text-glow-green' : 'text-red-400 text-glow-red'}">${formatMoney(pnl)}</div>
                        <div class="text-[10px] text-gray-500 font-mono mt-1">SCORE: <span class="text-gray-300">${r.avg_score || '-'}</span> ‚Ä¢ WR: <span class="text-gray-300">${r.win_rate || '-'}%</span></div>
                    </div>
                    <p class="text-xs text-gray-500 italic border-t border-[#222] pt-2 mt-2">"${snippet}"</p>
                </div>`;
            }).join('');
        }

        function buildSymbolPerformance() {
            const s = Object.entries(rawData.symbols || {}).sort((a,b)=>b[1].pnl-a[1].pnl).slice(0,5);
            document.getElementById('symbolPerformance').innerHTML = s.map(([k,v]) => {
                const wr = v.trades > 0 ? ((v.wins/v.trades)*100).toFixed(0) : 0;
                return `<div class="flex justify-between p-3 bg-[#111] rounded border border-[#222] hover:border-[#333] transition-colors">
                    <div class="font-bold text-sm text-gray-300">${k}</div>
                    <div class="text-right text-sm">
                        <span class="${v.pnl>=0?'text-green-400':'text-red-400'} font-bold font-mono">${formatMoney(v.pnl)}</span>
                        <span class="text-gray-600 ml-2 text-xs font-mono">${wr}% WR</span>
                    </div>
                </div>`;
            }).join('');
        }

        function renderLastTradeWidget() {
            const t = allTrades[0];
            if(!t) return;
            document.getElementById('lastTradeWidget').classList.remove('hidden');
            const {full} = driveUrls(t.screenshot||t.screenshot_url_A);
            const img=document.getElementById('lt_image'), no=document.getElementById('lt_no_image');
            if(full) { img.src=full; img.classList.remove('hidden'); no.classList.add('hidden'); }
            else { img.classList.add('hidden'); no.classList.remove('hidden'); }

            document.getElementById('lt_symbol').textContent = t.symbol;
            document.getElementById('lt_side').textContent = t.side || 'FLAT';
            document.getElementById('lt_date').textContent = `${t.date} ${t.entry_time}`;
            
            const pnl = getNetPnL(t); // Net
            const pEl = document.getElementById('lt_pnl');
            pEl.textContent = formatMoney(pnl);
            pEl.className = `text-4xl md:text-5xl font-bold mt-2 font-mono ${pnl>=0?'text-green-400 text-glow-green':'text-red-400 text-glow-red'}`;
        }

        function openLastTrade() {
            if(allTrades.length > 0) openTradeModal(allTrades[0].trade_id);
        }

        function buildInsights() {
            const i = rawData.insights || [];
            if(i.length) document.getElementById('insightsContainer').innerHTML = `<div class="tech-card rounded-xl p-6 md:p-8">
                <h2 class="text-lg font-semibold mb-6 flex items-center gap-2"><span class="text-xl">üí°</span> Algorithm Insights</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${i.map(x => `<div class="bg-[#111] p-4 rounded border border-[#222]"><p class="text-sm text-gray-300 leading-relaxed">${x}</p></div>`).join('')}
                </div>
            </div>`;
        }

        function buildMetrics() {
            const t = rawData.trades;
            const net = t.reduce((s,x)=>s+getNetPnL(x),0); // Net
            const wins = t.filter(x=>getNetPnL(x)>0); // Net
            const losses = t.filter(x=>getNetPnL(x)<0); // Net
            
            const wr = t.length ? (wins.length/t.length)*100 : 0;
            const grossWin = wins.reduce((s,x)=>s+getNetPnL(x),0);
            const grossLoss = Math.abs(losses.reduce((s,x)=>s+getNetPnL(x),0));
            const pf = grossLoss > 0 ? grossWin/grossLoss : grossWin;
            const curBal = rawData.startingBalance + net;

            const m = [
                {l:'Net Profit', v:formatMoney(net), c:net>=0?'text-green-400 text-glow-green':'text-red-400 text-glow-red', mono:true},
                {l:'Win Rate', v:wr.toFixed(2)+'%', c:wr>=50?'text-green-400':'text-red-400', visual:true, p:wr, mono:true},
                {l:'Avg Net P&L', v:formatMoney(t.length?net/t.length:0), c:net>=0?'text-green-400':'text-red-400', mono:true},
                {l:'Profit Factor', v:pf.toFixed(2), c:pf>=1.5?'text-green-400':pf>=1?'text-white':'text-red-400', mono:true},
                {l:'Balance', v:'$'+curBal.toFixed(2), c:'text-white', sub:`${((net/rawData.startingBalance)*100).toFixed(2)}% ROI`, mono:true}
            ];

            // NOTE: Updated text-2xl md:text-3xl here for mobile font size adjustment
            document.getElementById('metricsContainer').innerHTML = m.map(i => `<div class="tech-card p-5 rounded-lg flex flex-col justify-between">
                <p class="text-[10px] text-gray-500 uppercase font-bold tracking-widest mb-2">${i.l}</p>
                ${i.visual ? `<div class="flex justify-between items-center">
                    <p class="text-2xl md:text-3xl font-bold ${i.c} ${i.mono?'font-mono':''} tracking-tight truncate">${i.v}</p>
                    <svg class="w-10 h-10 -rotate-90 flex-shrink-0"><circle cx="20" cy="20" r="16" stroke="#222" stroke-width="3" fill="none"/><circle cx="20" cy="20" r="16" stroke="${i.p>=50?'#10b981':'#ef4444'}" stroke-width="3" fill="none" stroke-dasharray="${100.5 * i.p / 100} 100.5"></circle></svg>
                </div>` : `<p class="text-2xl md:text-3xl font-bold ${i.c} ${i.mono?'font-mono':''} tracking-tight truncate">${i.v}</p>`}
                ${i.sub ? `<p class="text-[10px] text-gray-500 mt-2 font-mono">${i.sub}</p>` : ''}
            </div>`).join('');
        }

        function buildEvaluationPanel() {
            const t = rawData.trades;
            const wins = t.filter(x=>getNetPnL(x)>0);
            const losses = t.filter(x=>getNetPnL(x)<0);
            const net = t.reduce((s,x)=>s+getNetPnL(x),0);
            const totalFees = t.reduce((s,x)=>s+parseMoneyValue(x.fees||0),0);
            const avgPL = t.length ? net / t.length : 0;
            const biggestWinner = t.length ? Math.max(...t.map(x=>getNetPnL(x))) : 0;
            const biggestLoser = t.length ? Math.min(...t.map(x=>getNetPnL(x))) : 0;
            const totalMins = t.reduce((s,x)=>s+getHoldTime(x),0);
            const avgHold = t.length ? (totalMins/t.length).toFixed(0) : 0;
            const activeTrades = wins.length + losses.length;
            const realWr = activeTrades ? ((wins.length/activeTrades)*100).toFixed(2) : '0.00';
            const roi = ((net / rawData.startingBalance)*100).toFixed(2);
            const uniqueDays = new Set(t.map(x=>x.date)).size;
            const tpd = uniqueDays ? (t.length/uniqueDays).toFixed(1) : 0;
            const tpw = uniqueDays ? (t.length/(uniqueDays/5)).toFixed(1) : 0;

            let maxPeak = -Infinity;
            let maxDD = 0;
            let bal = rawData.startingBalance;
            const revT = [...t].reverse();
            revT.forEach(tr => {
                bal += getNetPnL(tr);
                if(bal > maxPeak) maxPeak = bal;
                const dd = (maxPeak - bal) / maxPeak * 100;
                if(dd > maxDD) maxDD = dd;
            });

            let streakHtml = [];
            const recent = t.slice(0, 5).reverse();
            for(let i = 0; i < recent.length; i++) {
                const p = getNetPnL(recent[i]);
                if(p > 0) streakHtml.push('<span class="text-green-400 font-bold mx-1 font-mono">W</span>');
                else if(p < 0) streakHtml.push('<span class="text-red-400 font-bold mx-1 font-mono">L</span>');
                else streakHtml.push('<span class="text-gray-500 mx-1 font-mono">B</span>');
            }

            const rows = [
                {l:'Total Number of Trades', v:t.length, mono:true},
                {l:'Avg. Net Profit per Trade', v:formatMoney(avgPL), c:avgPL>=0?'text-green-400':'text-red-400', mono:true},
                {l:'Biggest Winner (Net)', v:formatMoney(biggestWinner), c:'text-green-400', mono:true},
                {l:'Biggest Loser (Net)', v:formatMoney(biggestLoser), c:'text-red-400', mono:true},
                {l:'Total Fees Paid', v:`$${totalFees.toFixed(2)}`, mono:true},
                {l:'Avg. Hold Time (Minutes)', v:`${avgHold}`, mono:true},
                {l:'Winrate (Net, w/o BE)', v:`${realWr}%`, mono:true},
                {l:'ROI (Net)', v:`${roi}%`, c:roi>=0?'text-green-400':'text-red-400', mono:true},
                {l:'Max Drawdown', v:`${maxDD.toFixed(2)}%`, c:'text-red-400', mono:true},
                {l:'Winning / Losing Trades', v:`${wins.length} / ${losses.length}`, mono:true},
                {l:'Trades Per Day / Week', v:`${tpd} / ${tpw}`, mono:true},
                {l:'Current Streak', v:streakHtml.join('')}
            ];

            document.getElementById('evaluationPanel').innerHTML = rows.map(r => 
                `<div class="flex justify-between items-center py-4 px-2 hover:bg-[#111] transition-colors rounded">
                    <span class="text-gray-500 text-sm font-medium tracking-wide">${r.l}</span>
                    <span class="text-sm ${r.c||'text-white'} ${r.mono?'font-mono':''} font-bold">${r.v}</span>
                </div>`
            ).join('');
        }

        let calYear = new Date().getFullYear(), calMonth = new Date().getMonth();
        function renderCalendar() {
            const mNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
            document.getElementById('calendarMonthYear').textContent = `${mNames[calMonth]} ${calYear}`;
            
            const firstDay = new Date(calYear, calMonth, 1).getDay();
            const daysInMonth = new Date(calYear, calMonth+1, 0).getDate();
            const offset = firstDay === 0 ? 6 : firstDay - 1;
            
            const today = new Date();
            const isCurrentMonth = today.getFullYear()===calYear && today.getMonth()===calMonth;
            const currentDay = today.getDate();

            let html = '';
            let weekTrades = 0, weekPnL = 0;

            for(let i=0; i<offset; i++) html += `<div class="h-14 md:h-20 bg-[#0a0a0a] border border-[#1a1a1a] rounded-lg opacity-50"></div>`;

            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const dayTrades = rawData.trades.filter(t => t.date === dateStr);
                const dayPnL = dayTrades.reduce((s,t)=>s+getNetPnL(t),0); // Net
                
                weekTrades += dayTrades.length;
                weekPnL += dayPnL;

                let bg = 'bg-[#0e0e0e]', border='border-[#1a1a1a]', txt='text-gray-600';
                if(dayTrades.length) {
                    bg = dayPnL>=0 ? 'bg-[rgba(16,185,129,0.15)]' : 'bg-[rgba(244,63,94,0.15)]';
                    border = dayPnL>=0 ? 'border-green-500/30' : 'border-red-500/30';
                    txt = dayPnL>=0 ? 'text-green-400 text-glow-green' : 'text-red-400 text-glow-red';
                }

                const isToday = isCurrentMonth && d === currentDay ? 'current-day' : '';
                
                let clickAttr = '';
                let hoverClass = '';
                if(dayTrades.length > 0) {
                    clickAttr = `onclick="openDayModal('${dateStr}')"`;
                    hoverClass = 'has-trades';
                }

                html += `<div ${clickAttr} class="calendar-day ${hoverClass} h-14 md:h-20 rounded-lg ${border} ${bg} ${isToday} flex flex-col items-center justify-center relative group">
                    <span class="text-[10px] md:text-xs font-bold text-gray-500 absolute top-2 right-3 font-mono">${d}</span>
                    ${dayTrades.length ? `<span class="text-xs md:text-sm font-bold ${txt} font-mono">${formatMoney(dayPnL)}</span><span class="text-[9px] md:text-[10px] text-gray-600 font-mono mt-1">${dayTrades.length}t</span>` : ''}
                </div>`;

                const dayOfWeek = new Date(calYear, calMonth, d).getDay();
                if(dayOfWeek === 0 || d === daysInMonth) {
                    let wHtml = `<div class="h-14 md:h-20 bg-transparent border border-transparent rounded-lg"></div>`;
                    if(weekTrades > 0) {
                        const isProfit = weekPnL >= 0;
                        const wBorder = isProfit ? 'border-green-900/20' : 'border-red-900/20';
                        const wTxt = isProfit ? 'text-green-500' : 'text-red-500';
                        wHtml = `<div class="h-14 md:h-20 rounded-lg border ${wBorder} bg-[#0c0c0c] flex flex-col items-center justify-center relative week-total">
                            <span class="text-[8px] md:text-[9px] uppercase text-gray-600 font-bold mb-1 opacity-70 tracking-widest">Week</span>
                            <span class="text-xs md:text-sm font-bold ${wTxt} font-mono">${formatMoney(weekPnL)}</span>
                            <span class="text-[9px] md:text-[10px] text-gray-600 font-mono mt-1">${weekTrades}t</span>
                        </div>`;
                    }
                    html += wHtml;
                    weekTrades = 0; weekPnL = 0;
                }
            }
            document.getElementById('calendarGrid').innerHTML = html;
        }

        // --- NEW DAY MODAL LOGIC ---
        function openDayModal(dateStr) {
            const trades = rawData.trades.filter(t => t.date === dateStr);
            if(trades.length === 0) return;

            const total = trades.reduce((s,t) => s + getNetPnL(t), 0);
            
            const dateObj = new Date(dateStr);
            const dateFmt = dateObj.toLocaleDateString('en-US', {weekday:'long', month:'short', day:'numeric'});
            document.getElementById('d_date').textContent = dateFmt;
            
            const pnlEl = document.getElementById('d_pnl');
            pnlEl.textContent = (total >= 0 ? 'DAY TOTAL: +' : 'DAY TOTAL: ') + formatMoney(total).replace(/[+-]/,'');
            pnlEl.className = `text-sm font-bold font-mono ${total>=0?'text-green-400 text-glow-green':'text-red-400 text-glow-red'}`;

            const html = trades.map(t => {
                const pnl = getNetPnL(t);
                const isWin = pnl >= 0;
                return `<div onclick="openTradeModal('${t.trade_id}')" class="flex justify-between items-center p-3 hover:bg-[#222] rounded cursor-pointer border border-transparent hover:border-[#333] transition-colors mb-1 group">
                    <div class="flex items-center gap-3">
                        <span class="font-mono text-xs text-gray-500 w-12 text-center bg-[#111] py-1 rounded border border-[#222] group-hover:border-[#444]">${t.entry_time.substring(0,5)}</span>
                        <div>
                            <div class="font-bold text-sm text-gray-200">${t.symbol}</div>
                            <div class="text-[10px] uppercase text-gray-500 font-bold tracking-wider">${t.side}</div>
                        </div>
                    </div>
                    <span class="font-bold text-sm font-mono ${isWin?'text-green-400':'text-red-400'}">${formatMoney(pnl)}</span>
                </div>`;
            }).join('');

            document.getElementById('d_tradeList').innerHTML = html;
            openModal('dayModal');
        }

        window.changeCalendarMonth = (d) => {
            calMonth += d;
            if(calMonth>11){calMonth=0;calYear++}
            if(calMonth<0){calMonth=11;calYear--}
            renderCalendar();
        }

        function initCharts() {
            Chart.defaults.color='#6b7280';
            Chart.defaults.borderColor='#1f1f1f';
            Chart.defaults.font.family = "'JetBrains Mono', monospace";
            
            const ctx = document.getElementById('equityChart').getContext('2d');
            
            equityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels:[],
                    datasets:[{
                        label:'Net Equity',
                        data:[],
                        fill: {
                            target: { value: rawData.startingBalance },
                            above: 'rgba(16, 185, 129, 0.15)',
                            below: 'rgba(244, 63, 94, 0.15)'
                        },
                        segment: {
                            borderColor: ctx => ctx.p0.parsed.y >= rawData.startingBalance ? '#10b981' : '#f43f5e'
                        },
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#fff',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: {display:false}, tooltip: {mode:'index', intersect:false, backgroundColor: '#111', titleColor: '#fff', bodyColor: '#ccc', borderColor: '#333', borderWidth: 1, titleFont: {family: "'JetBrains Mono', monospace"}, bodyFont: {family: "'JetBrains Mono', monospace"}} },
                    scales: { x: {grid:{display:false}}, y: {border:{display:false}, grid:{color:'#1a1a1a'}} },
                    interaction: { mode: 'nearest', axis: 'x', intersect: false }
                }
            });
            switchEquityView('trades');

            const sortedHours = Object.keys(rawData.hours).sort();
            new Chart(document.getElementById('timeAnalysisChart'), {
                type: 'bar',
                data: {
                    labels: sortedHours.map(k=>k+':00'),
                    datasets:[{
                        data: sortedHours.map(k=>rawData.hours[k].pnl),
                        backgroundColor: sortedHours.map(k=>rawData.hours[k].pnl>=0?'#10b981':'#f43f5e'),
                        borderRadius: 2
                    }]
                },
                options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}, y:{grid:{color:'#1a1a1a'}, border:{display:false}}} }
            });

            const wDays=['Monday','Tuesday','Wednesday','Thursday','Friday'];
            new Chart(document.getElementById('weekdayChart'), {
                type: 'bar',
                data: {
                    labels: wDays,
                    datasets:[{
                        data: wDays.map(d=>(rawData.weekdays[d]||{}).pnl||0),
                        backgroundColor: wDays.map(d=>(rawData.weekdays[d]||{}).pnl>=0?'#10b981':'#f43f5e'),
                        borderRadius: 2
                    }]
                },
                options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}, y:{grid:{color:'#1a1a1a'}, border:{display:false}}} }
            });
        }

        function displayTrades(page=1) {
            const start = (page-1)*tradesPerPage;
            const end = Math.min(start+tradesPerPage, filteredTrades.length);
            const show = filteredTrades.slice(start, end);

            document.getElementById('tradesTableBody').innerHTML = show.map(t => {
                const {full} = driveUrls(t.screenshot||t.screenshot_url_A);
                const pnl = getNetPnL(t); // Net
                const balance = t.runningBalance || 0;
                
                return `<tr class="trade-row border-b border-[#1a1a1a] transition-all hover:bg-[#111]" onclick="openTradeModal('${t.trade_id}')">
                    <td class="py-4 px-5 text-left font-mono text-xs text-blue-400 font-bold hover:underline tracking-wide">${t.trade_id}</td>
                    <td class="py-4 px-5 text-left text-xs text-gray-400 font-mono">${t.date}</td>
                    <td class="py-4 px-5 text-left text-sm font-bold text-gray-200">${t.symbol}</td>
                    <td class="py-4 px-5 text-left hide-mobile"><span class="badge ${t.side?.toLowerCase().includes('long')?'badge-green':'badge-red'}">${t.side}</span></td>
                    <td class="py-4 px-5 text-left hide-mobile text-xs text-gray-400 font-mono">${parseFloat(t.entry_price).toFixed(2)}</td>
                    <td class="py-4 px-5 text-left hide-mobile text-xs text-gray-400 font-mono">${parseFloat(t.exit_price).toFixed(2)}</td>
                    <td class="py-4 px-5 text-right text-sm font-bold font-mono ${pnl>=0?'text-green-400':'text-red-400'}">${formatMoney(pnl)}</td>
                    <td class="py-4 px-5 text-right hide-mobile text-xs text-gray-500 font-mono">$${balance.toFixed(2)}</td>
                    <td class="py-4 px-5 text-center" onclick="event.stopPropagation()">
                        ${full ? `<div class="screenshot-link" onclick="openTradeModal('${t.trade_id}')"><span class="badge badge-gray cursor-pointer hover:bg-white hover:text-black transition-colors">IMG</span></div>` : '<span class="text-gray-700 text-xs">-</span>'}
                    </td>
                </tr>`;
            }).join('');
            
            document.getElementById('paginationInfo').textContent = `SHOWING ${start+1}-${end} OF ${filteredTrades.length}`;
            document.getElementById('prevPage').disabled = page <= 1;
            document.getElementById('nextPage').disabled = page >= Math.ceil(filteredTrades.length/tradesPerPage);
            currentPage = page;
        }

        // --- NEW: REVIEW MODAL LOGIC ---
        function openReviewModal(id) {
            const idx = allReviews.findIndex(r => r.review_id === id);
            if(idx === -1) return;
            currentReviewIndex = idx;
            renderReviewModalContent();
            openModal('reviewModal');
        }

        function renderReviewModalContent() {
            const r = allReviews[currentReviewIndex];
            if(!r) return;

            document.getElementById('r_date').textContent = r.date;
            document.getElementById('r_type').textContent = r.type || 'Review';
            
            const pnl = parseMoneyValue(r.net_pl);
            const pnlEl = document.getElementById('r_pnl');
            pnlEl.textContent = formatMoney(pnl);
            pnlEl.className = `text-2xl font-bold mt-1 font-mono ${pnl >= 0 ? 'text-green-400 text-glow-green' : 'text-red-400 text-glow-red'}`;

            document.getElementById('r_wr').textContent = (r.win_rate || '0') + '%';
            document.getElementById('r_score').textContent = r.avg_score || '-';
            
            const cost = parseMoneyValue(r.cost_of_errors);
            document.getElementById('r_cost').textContent = formatMoney(cost);
            
            document.getElementById('r_ai_insight').innerHTML = formatText(r.ai_insight);
            document.getElementById('r_reflection').innerHTML = formatText(r.user_reflection);
        }

        function formatText(text) {
            if(!text) return '<em class="text-gray-600 font-mono text-xs">NO DATA AVAILABLE.</em>';
            return text.replace(/\n/g, '<br>');
        }

        function navigateReview(d) {
            if(activeModalId !== 'reviewModal') return;
            const n = currentReviewIndex + d;
            if(n >= 0 && n < allReviews.length) {
                currentReviewIndex = n;
                renderReviewModalContent();
            }
        }

        // --- GENERIC MODAL HANDLERS ---
        function openTradeModal(id) {
            const idx = allTrades.findIndex(t => t.trade_id === id);
            if(idx === -1) return;
            currentTradeIndex = idx;
            renderTradeModalContent();
            openModal('tradeModal');
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            activeModalId = modalId;
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            // Check if Day Modal is still open (nested scenario)
            if(modalId === 'tradeModal' && !document.getElementById('dayModal').classList.contains('hidden')) {
                activeModalId = 'dayModal';
                // Do NOT re-enable scrolling
            } else {
                document.body.style.overflow = '';
                activeModalId = null;
            }
        }

        function navigateTrade(d) {
            if(activeModalId !== 'tradeModal') return;
            const n = currentTradeIndex + d;
            if(n>=0 && n<allTrades.length) {
                currentTradeIndex = n;
                renderTradeModalContent();
            }
        }

        function renderTradeModalContent() {
            const t = allTrades[currentTradeIndex];
            if(!t) return;
            
            document.getElementById('m_tradeId').textContent = t.trade_id;
            
            document.getElementById('m_date').textContent = t.date;
            
            document.getElementById('m_time').textContent = t.entry_time;
            
            const symEl = document.getElementById('m_symbol');
            if(symEl) symEl.textContent = t.symbol;

            document.getElementById('m_side').textContent = t.side;
            document.getElementById('m_side').className = `px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wide ${t.side?.toLowerCase().includes('long')?'bg-green-900/30 text-green-300 border border-green-800':'bg-red-900/30 text-red-300 border border-red-800'}`;
            
            const pnl = getNetPnL(t); // Net
            const pnlFormatted = formatMoney(pnl);
            
            // Desktop PnL
            document.getElementById('m_pnl').textContent = pnlFormatted;
            document.getElementById('m_pnl').className = `text-3xl font-bold leading-none mt-1 font-mono ${pnl>=0?'text-green-400 text-glow-green':'text-red-400 text-glow-red'}`;
            
            // Mobile PnL (This ID *does* exist in your HTML, so we keep it)
            const mobPnl = document.getElementById('m_pnl_mob');
            if(mobPnl) {
                mobPnl.textContent = pnlFormatted;
                mobPnl.className = `text-2xl font-bold font-mono ${pnl>=0?'text-green-400':'text-red-400'}`;
            }
            
            document.getElementById('m_entry_price').textContent = parseFloat(t.entry_price).toFixed(2);
            document.getElementById('m_exit_price').textContent = parseFloat(t.exit_price).toFixed(2);
            document.getElementById('m_setup').textContent = t.setup || '-';
            document.getElementById('m_session').textContent = t.session || '-';
            document.getElementById('m_score').textContent = t.score || t['Total Score'] || '-';
            document.getElementById('m_fees').textContent = '-' + formatMoney(Math.abs(parseMoneyValue(t.fees||0)));
            document.getElementById('m_notes').textContent = t.notes || 'No notes recorded.';

            // Image Logic
            const {full} = driveUrls(t.screenshot||t.screenshot_url_A);
            const img=document.getElementById('m_image'), no=document.getElementById('m_no_image'), lnk=document.getElementById('m_full_link');
            if(full){ 
                img.src=full; 
                img.classList.remove('hidden'); 
                no.classList.add('hidden'); 
                lnk.href=full; 
                lnk.classList.remove('opacity-0'); 
            } else { 
                img.classList.add('hidden'); 
                no.classList.remove('hidden'); 
                lnk.classList.add('opacity-0'); 
            }

            // Tags Logic
            const setTag = (id,v) => {
                const el=document.getElementById(id);
                if(!el) return;
                el.textContent=v||'-';
                let style = 'badge badge-gray';
                if(v?.match(/follow|complete/i)) style = 'badge badge-green';
                if(v?.match(/fail|no|impulse|error|tilt/i)) style = 'badge badge-red';
                el.className=style;
            };
            setTag('m_tag_pre', t.pre_trade);
            setTag('m_tag_entry', t.trade_entry);
            setTag('m_tag_mgmt', t.trade_management);
            setTag('m_tag_exit', t.trade_exit);
        }

        window.filterTrades = () => {
            const q = document.getElementById('tradeSearch').value.toLowerCase();
            const type = document.getElementById('tradeFilter').value;
            filteredTrades = allTrades.filter(t => {
                const net = getNetPnL(t); // Filter by Net
                return (t.symbol.toLowerCase().includes(q) || t.notes?.toLowerCase().includes(q)) && 
                       (type===''?true:type==='win'?net>0:net<0);
            });
            displayTrades(1);
        }

        window.changePage = (d) => {
            const max = Math.ceil(filteredTrades.length/tradesPerPage);
            const next = currentPage+d;
            if(next>=1 && next<=max) displayTrades(next);
        }

        window.switchEquityView = (mode) => {
            const d = mode==='days' ? rawData.equityDays : rawData.equityTrades;
            equityChart.data.labels = d.map(x => mode==='days' ? x.date : 'T'+x.trade);
            equityChart.data.datasets[0].data = d.map(x => x.equity);
            equityChart.update();
            document.getElementById('equityByTrades').className = mode==='trades'?'btn-tech active':'btn-tech';
            document.getElementById('equityByDays').className = mode==='days'?'btn-tech active':'btn-tech';
        }

        document.addEventListener('keydown', e => {
            if(activeModalId === 'tradeModal') {
                if(e.key==='ArrowLeft')navigateTrade(-1);
                if(e.key==='ArrowRight')navigateTrade(1);
                if(e.key==='Escape')closeModal('tradeModal');
            } else if(activeModalId === 'reviewModal') {
                if(e.key==='ArrowLeft')navigateReview(-1);
                if(e.key==='ArrowRight')navigateReview(1);
                if(e.key==='Escape')closeModal('reviewModal');
            } else if(activeModalId === 'dayModal') {
                if(e.key==='Escape')closeModal('dayModal');
            } else {
                if(e.key.toLowerCase()==='r') location.reload();
            }
        });
    </script>
</body>
</html>
