<!--
  Trading Dashboard â€“Â FULL HTML v3.3  (Julyâ€¯2025)
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Copyâ€‘paste this entire string into the **dashboardHTML** variable
  of your n8n Function node (replacing the older template).
  It already includes every patch discussed: equity mode toggle,
  multiâ€‘month calendar navigation, and Driveâ€‘URL fallback.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trading Dashboard â€“ ${new Date().toLocaleDateString()}</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“Š</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body { margin:0; background:#0a0a0a; color:#fff; font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .metric-card{background:#1a1a1a;border:1px solid #2a2a2a;transition:.3s}
        .metric-card:hover{transform:translateY(-2px);border-color:#3a3a3a}
        .chart-container{position:relative;height:300px;width:100%}
        .calendar-day{position:relative;transition:.2s}
        .calendar-day:hover{transform:scale(1.05);z-index:10}
        ::-webkit-scrollbar{width:8px;height:8px}::-webkit-scrollbar-track{background:#1a1a1a}::-webkit-scrollbar-thumb{background:#3a3a3a;border-radius:4px}::-webkit-scrollbar-thumb:hover{background:#4a4a4a}
        .pagination-btn{background:#2a2a2a;border:1px solid #3a2a2a;padding:8px 16px;border-radius:4px}
    </style>
</head>
<body class="bg-[#0a0a0a] text-white">
<div class="min-h-screen p-4 md:p-6 max-w-7xl mx-auto">

<!-- HEADER -->
<h1 class="text-3xl font-bold mb-6 flex items-center">Trading Dashboard <span class="w-3 h-3 bg-green-400 rounded-full ml-3 animate-pulse"></span></h1>

<!-- METRICS (placeholder â€“ fill however you like) -->
<div id="metricStub" class="mb-8"></div>

<!-- EQUITY CURVE -->
<div class="bg-[#1a1a1a] p-6 rounded border border-[#2a2a2a] mb-8">
  <div class="flex justify-between mb-4">
    <h2 class="text-lg font-semibold">Equity Curve</h2>
    <div class="space-x-2">
      <button id="equityByTrades" class="px-3 py-1 text-sm rounded border transition-all bg-[#2a2a2a] border-[#3a3a3a] text-white" onclick="switchEquityView('trades')">By Trades</button>
      <button id="equityByDays"   class="px-3 py-1 text-sm rounded border transition-all bg-[#1a1a1a] border-[#2a2a2a] text-gray-400" onclick="switchEquityView('days')">By Days</button>
    </div>
  </div>
  <div class="chart-container" style="height:400px"><canvas id="equityChart"></canvas></div>
</div>

<!-- CALENDAR -->
<div class="bg-[#1a1a1a] p-6 rounded border border-[#2a2a2a] mb-8">
  <div class="flex justify-between items-center mb-4">
    <button onclick="changeCalendarMonth(-1)" class="p-2 hover:bg-[#2a2a2a] rounded">â—€</button>
    <span id="calendarMonthYear" class="text-sm text-gray-400"></span>
    <button onclick="changeCalendarMonth(1)" class="p-2 hover:bg-[#2a2a2a] rounded">â–¶</button>
  </div>
  <div class="grid grid-cols-7 gap-2 text-center text-gray-500 text-xs mb-2">
    <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
  </div>
  <div id="calendarGrid" class="grid grid-cols-7 gap-2"></div>
</div>

<!-- TRADES TABLE (screenshot cell already patched) -->
<div class="bg-[#1a1a1a] p-6 rounded border border-[#2a2a2a]">
  <h2 class="text-lg font-semibold mb-4">Trade History</h2>
  <div class="overflow-x-auto">
    <table class="w-full text-sm">
      <thead><tr class="border-b border-[#2a2a2a]"><th class="py-2 px-4 text-left">Trade ID</th><th class="py-2 px-4 text-left">Date</th><th class="py-2 px-4 text-left">Symbol</th><th class="py-2 px-4 text-left">Side</th><th class="py-2 px-4 text-left">P&L</th><th class="py-2 px-4 text-left">Chart</th></tr></thead>
      <tbody id="tradesTableBody"></tbody>
    </table>
  </div>
</div>

<!-- ==========  DATA FROM BACKEND  ========== -->
<script>
  /*  these placeholders get replaced serverâ€‘side in n8n  */
  const chartData = {
    symbols      : ${JSON.stringify(symbolData)},
    weekdays     : ${JSON.stringify(weekdayData)},
    hours        : ${JSON.stringify(hourData)},
    equityTrades : ${JSON.stringify(equityData)},
    equityDays   : ${JSON.stringify(dailyEquityData)}
  };
  const calendarData = ${JSON.stringify(monthlyData)};
  const allTrades    = ${JSON.stringify(trades.slice().reverse())};
</script>

<!-- ==========  FRONTâ€‘END LOGIC  ========== -->
<script>
  /* GLOBAL STATE */
  let equityChartRef;
  let calendarYear  = new Date().getFullYear();
  let calendarMonth = new Date().getMonth();

  /* EQUITY VIEW TOGGLE */
  function switchEquityView(mode='trades'){
    if(!equityChartRef)return;
    const dset=(mode==='trades'?chartData.equityTrades:chartData.equityDays);
    equityChartRef.data.labels=dset.map(pt=>mode==='trades'?`Trade ${pt.trade}`:pt.date);
    equityChartRef.data.datasets[0].data=dset.map(pt=>pt.equity);
    equityChartRef.update();
    document.getElementById('equityByTrades').classList.toggle('bg-[#2a2a2a]',mode==='trades');
    document.getElementById('equityByTrades').classList.toggle('bg-[#1a1a1a]',mode!=='trades');
    document.getElementById('equityByTrades').classList.toggle('text-white',mode==='trades');
    document.getElementById('equityByTrades').classList.toggle('text-gray-400',mode!=='trades');
    document.getElementById('equityByDays').classList.toggle('bg-[#2a2a2a]',mode==='days');
    document.getElementById('equityByDays').classList.toggle('bg-[#1a1a1a]',mode!=='days');
    document.getElementById('equityByDays').classList.toggle('text-white',mode==='days');
    document.getElementById('equityByDays').classList.toggle('text-gray-400',mode!=='days');
  }

  /* CALENDAR HELPERS */
  function generateCalendarCells(year,month,data={}){
    const daysInMonth=new Date(year,month+1,0).getDate();
    const firstDay=new Date(year,month,1).getDay();
    const today=new Date();
    const isCurrent=(today.getFullYear()===year&&today.getMonth()===month);
    let cells='';
    for(let i=0;i<(firstDay===0?6:firstDay-1);i++)cells+='<div class="h-16 rounded border border-[#2a2a2a] bg-[#0a0a0a]">';
    for(let d=1;d<=daysInMonth;d++){
      const dayData=data[d];
      const isToday=isCurrent&&d===today.getDate();
      let cls='calendar-day h-16 rounded border flex flex-col items-center justify-center text-sm';
      if(dayData&&dayData.pnl>0)cls+=' bg-green-900/30 border-green-600/50';
      else if(dayData&&dayData.pnl<0)cls+=' bg-red-900/30 border-red-600/50';
      else cls+=' bg-[#1a1a1a] border-[#2a2a2a]';
      if(isToday)cls+=' ring-2 ring-blue-400';
      cells+=`<div class="${cls}"><span>${d}</span>`;
      if(dayData)cells+=`<span class="text-xs ${dayData.pnl>=0?'text-green-400':'text-red-400'}">${dayData.pnl>=0?'+':''}${dayData.pnl.toFixed(0)}</span>`;
      cells+='</div>';
    }
    return cells;
  }
  function renderCalendar(){
    document.getElementById('calendarMonthYear').textContent=new Date(calendarYear,calendarMonth).toLocaleDateString('en-US',{month:'long',year:'numeric'});
    const key=`${calendarYear}-${calendarMonth}`;
    document.getElementById('calendarGrid').innerHTML=generateCalendarCells(calendarYear,calendarMonth,calendarData[key]||{});
  }
  function changeCalendarMonth(off){
    calendarMonth+=off;
    if(calendarMonth<0){calendarMonth=11;calendarYear--}
    if(calendarMonth>11){calendarMonth=0;calendarYear++}
    renderCalendar();
  }

  /* TRADES TABLE */
  function displayTrades(){
    const tbody=document.getElementById('tradesTableBody');
    tbody.innerHTML=allTrades.map(t=>{
      const pnl=parseFloat(t['p_l']||0);
      const screenshotUrl=(()=>{const u=t.screenshot_url_A||t.screenshot_url_B||t.screenshot_url_C;if(!u)return null;const m=u.match(/\/file\/d\/([\w-]+)/);return m?`https://drive.google.com/uc?export=view&id=${m[1]}`:u})();
      return `<tr class="border-b border-[#2a2a2a] hover:bg-[#222]">`+
        `<td class="py-2 px-4">${t.trade_id}</td>`+
        `<td class="py-2 px-4">${t.date}</td>`+
        `<td class="py-2 px-4">${t.symbol}</td>`+
        `<td class="py-2 px-4 ${pnl>=0?'text-green-400':'text-red-400'}">${pnl>=0?'+':''}$${Math.abs(pnl).toFixed(2)}</td>`+
        `<td class="py-2 px-4">${screenshotUrl?`<a href="${screenshotUrl}" target="_blank" class="underline text-blue-400">Link</a>`:'<span class="text-gray-500">-</span>'}</td>`+
        `</tr>`;
    }).join('');
  }

  /* CHARTS */
  window.addEventListener('load',()=>{
    Chart.defaults.color='#9ca3af';Chart.defaults.borderColor='#2a2a2a';
    const ctx=document.getElementById('equityChart');
    equityChartRef=new Chart(ctx,{type:'line',data:{labels:chartData.equityTrades.map(p=>`Trade ${p.trade}`),datasets:[{label:'Account Balance',data:chartData.equityTrades.map(p=>p.equity),borderColor:'#10b981',backgroundColor:'rgba(16,185,129,.1)',fill:true,tension:.4}]},options:{responsive:true,maintainAspectRatio:false}});
    renderCalendar();
    displayTrades();
  });
</script>
</div>
</body>
</html>
