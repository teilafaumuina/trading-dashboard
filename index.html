<script>
// â•â•â•â• CONFIG â•â•â•â•
const DATA_URL = './data.json';
const STARTING_BALANCE = 50000;

// â•â•â•â• STATE â•â•â•â•
let rawData = {}, allTrades = [], filteredTrades = [];
let currentPage = 1, tradesPerPage = 15;
let equityChart, timeChart, symbolChart, weekdayChart;
let modalOpen = false, currentTradeIndex = -1;

// â•â•â•â• UTILS â•â•â•â•
const formatMoney = (v) => (parseFloat(v) || 0) >= 0 ? '+$' + Math.abs(v).toFixed(2) : '-$' + Math.abs(v).toFixed(2);

const parseMoneyValue = (v) => {
  if (v === null || v === undefined || v === '') return 0;
  const c = v.toString().replace(/[$,]/g, '');
  const n = parseFloat(c);
  return isNaN(n) ? 0 : n;
};

// Net P&L = gross p_l - fees
const getNetPnL = (t) => parseMoneyValue(t.p_l) - parseMoneyValue(t.fees || 0);

const getHoldTime = (t) => {
  if (!t.entry_time || !t.exit_time) return 0;
  const d1 = new Date(`2000-01-01T${t.entry_time}`);
  const d2 = new Date(`2000-01-01T${t.exit_time}`);
  const diffMs = d2 - d1;
  return diffMs > 0 ? Math.floor(diffMs / 60000) : 0;
};

const driveUrls = (url) => {
  if (!url) return { thumb: null, full: null };
  let id = null;
  const m1 = url.match(/\/file\/d\/([\w-]+)/);
  const m2 = url.match(/id=([\w-]+)/);
  if (m1) id = m1[1];
  else if (m2) id = m2[1];
  if (id) return {
    thumb: `https://drive.google.com/thumbnail?id=${id}&sz=w400`,
    full: `https://drive.google.com/thumbnail?id=${id}&sz=w1920`
  };
  return { thumb: url, full: url };
};

// YYYY-MM-DD
const toDateKey = (d) => d;

// HH => 0..23
const parseHour = (t) => {
  if (!t.entry_time) return null;
  const parts = t.entry_time.split(':');
  const h = parseInt(parts[0], 10);
  return Number.isFinite(h) ? h : null;
};

// Monday..Sunday (we chart Mon-Fri)
const weekdayName = (dateStr) => {
  const d = new Date(dateStr + 'T00:00:00');
  // JS: 0=Sun..6=Sat
  const map = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  return map[d.getDay()];
};

// Derive ALL aggregates from NET P&L so nothing relies on gross pre-calcs
function buildDerivedStats(trades, equityTrades, startingBalance) {
  const symbols = {};
  const hours = {};     // keys "0".."23"
  const weekdays = {};  // keys weekday names
  const dayMap = new Map(); // date => net pnl

  let totalFees = 0;
  let biggestWinner = -Infinity;
  let biggestLoser = Infinity;

  for (const t of trades) {
    const net = getNetPnL(t);
    const fees = parseMoneyValue(t.fees || 0);
    totalFees += fees;

    if (net > biggestWinner) biggestWinner = net;
    if (net < biggestLoser) biggestLoser = net;

    // Symbols
    const sym = (t.symbol || 'â€”').toUpperCase();
    if (!symbols[sym]) symbols[sym] = { pnl: 0, trades: 0, wins: 0, losses: 0 };
    symbols[sym].pnl += net;
    symbols[sym].trades += 1;
    if (net > 0) symbols[sym].wins += 1;
    if (net < 0) symbols[sym].losses += 1;

    // Hours
    const h = parseHour(t);
    if (h !== null) {
      const key = String(h);
      if (!hours[key]) hours[key] = { pnl: 0, trades: 0 };
      hours[key].pnl += net;
      hours[key].trades += 1;
    }

    // Weekdays
    const wd = weekdayName(t.date);
    if (!weekdays[wd]) weekdays[wd] = { pnl: 0, trades: 0 };
    weekdays[wd].pnl += net;
    weekdays[wd].trades += 1;

    // Per-day net
    dayMap.set(t.date, (dayMap.get(t.date) || 0) + net);
  }

  // Avg profit per trading day (net)
  const uniqueDays = dayMap.size;
  const avgPL = uniqueDays ? ([...dayMap.values()].reduce((s, v) => s + v, 0) / uniqueDays) : 0;

  // Max drawdown % from net equity curve
  let peak = startingBalance;
  let maxDDPct = 0;
  for (const p of equityTrades) {
    const eq = p.equity;
    if (eq > peak) peak = eq;
    const dd = peak > 0 ? ((peak - eq) / peak) * 100 : 0;
    if (dd > maxDDPct) maxDDPct = dd;
  }

  // Fill missing hours so chart aligns 0..23
  for (let i = 0; i < 24; i++) {
    const k = String(i);
    if (!hours[k]) hours[k] = { pnl: 0, trades: 0 };
  }

  // Guard infinities if no trades
  if (!Number.isFinite(biggestWinner)) biggestWinner = 0;
  if (!Number.isFinite(biggestLoser)) biggestLoser = 0;

  const metadata = {
    avgPL,
    biggestWinner,
    biggestLoser,
    totalFees,
    maxDrawdownPercent: maxDDPct
  };

  return { symbols, hours, weekdays, metadata, dayMap };
}

// â•â•â•â• INIT â•â•â•â•
document.addEventListener('DOMContentLoaded', async () => {
  try {
    const url = window.location.protocol.startsWith('http') ? `${DATA_URL}?v=${new Date().getTime()}` : DATA_URL;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);

    const data = await res.json();
    if (!data.trades) throw new Error("JSON missing 'trades' array");

    // Sort oldest -> newest for running balance build
    let sorted = [...(data.trades || [])].sort((a, b) => new Date(a.date + ' ' + a.entry_time) - new Date(b.date + ' ' + b.entry_time));

    // Build equity by trades from NET
    let b = STARTING_BALANCE;
    const eqT = [{ trade: 0, equity: b, date: 'Start' }];

    // We'll also build a daily map from NET to build equity by days
    const dMap = new Map();

    sorted = sorted.map((t, i) => {
      const net = getNetPnL(t);
      b += net;
      eqT.push({ trade: i + 1, equity: b, date: t.date });
      dMap.set(t.date, (dMap.get(t.date) || 0) + net);
      return { ...t, runningBalance: b };
    });

    // Newest first for UI
    allTrades = sorted.reverse();
    filteredTrades = [...allTrades];

    // Equity by days from NET
    let db = STARTING_BALANCE;
    const eqD = [{ day: 0, equity: db, date: 'Start' }];
    Array.from(dMap.entries())
      .sort((a, b) => new Date(a[0]) - new Date(b[0]))
      .forEach((e, i) => {
        db += e[1];
        eqD.push({ day: i + 1, equity: db, date: e[0] });
      });

    // Recompute aggregates from NET (over UI order does not matter; use chronological for drawdown stability)
    const derived = buildDerivedStats(sorted, eqT, STARTING_BALANCE);

    rawData = {
      ...data,
      trades: allTrades,
      startingBalance: STARTING_BALANCE,
      equityTrades: eqT,
      equityDays: eqD,
      symbols: derived.symbols,
      hours: derived.hours,
      weekdays: derived.weekdays,
      metadata: derived.metadata,
      // Keep original insights if provided
      insights: data.insights || []
    };

    document.getElementById('loadingState').classList.add('hidden');
    document.getElementById('mainDashboard').classList.remove('hidden');
    initDashboard();
  } catch (e) {
    document.getElementById('loadingState').classList.add('hidden');
    // Your HTML references errorState/errorDetail but they aren't in this snippet;
    // keeping your existing behaviour, but guard if missing.
    const es = document.getElementById('errorState');
    const ed = document.getElementById('errorDetail');
    if (es) es.classList.remove('hidden');
    if (ed) ed.textContent = e.message;
    console.error(e);
  }
});

function initDashboard() {
  document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
  buildMetrics();
  buildSymbolPerformance();
  buildEvaluationPanel();
  buildInsights();
  renderLastTradeWidget();
  initCharts();
  renderCalendar();
  displayTrades();
}

// â•â•â•â• RENDERERS â•â•â•â•
function buildSymbolPerformance() {
  const s = Object.entries(rawData.symbols || {}).sort((a, b) => b[1].pnl - a[1].pnl).slice(0, 5);
  document.getElementById('symbolPerformance').innerHTML = s.map(([k, v]) => {
    const wr = v.trades > 0 ? ((v.wins / v.trades) * 100).toFixed(0) : 0;
    return `<div class="flex justify-between p-3 bg-[#0a0a0a] rounded border border-[#222]">
      <div class="font-medium text-sm">${k}</div>
      <div class="text-right text-sm">
        <span class="${v.pnl >= 0 ? 'text-green-400' : 'text-red-400'} font-bold">${formatMoney(v.pnl)}</span>
        <span class="text-gray-500 ml-2 text-xs">${wr}% WR</span>
      </div>
    </div>`;
  }).join('');
}

function renderLastTradeWidget() {
  const t = allTrades[0];
  if (!t) return;
  document.getElementById('lastTradeWidget').classList.remove('hidden');
  const { full } = driveUrls(t.screenshot || t.screenshot_url_A);
  const img = document.getElementById('lt_image'), no = document.getElementById('lt_no_image');
  if (full) { img.src = full; img.classList.remove('hidden'); no.classList.add('hidden'); }
  else { img.classList.add('hidden'); no.classList.remove('hidden'); }

  document.getElementById('lt_symbol').textContent = t.symbol;
  document.getElementById('lt_side').textContent = t.side || 'FLAT';
  document.getElementById('lt_date').textContent = `${t.date} ${t.entry_time}`;

  const pnl = getNetPnL(t); // NET
  const pEl = document.getElementById('lt_pnl');
  pEl.textContent = formatMoney(pnl);
  pEl.className = `text-3xl md:text-4xl font-bold mt-1 ${pnl >= 0 ? 'text-green-400' : 'text-red-400'}`;
}

function openLastTrade() { if (allTrades.length > 0) openTradeModal(allTrades[0].trade_id); }

function buildInsights() {
  const i = rawData.insights || [];
  if (i.length) document.getElementById('insightsContainer').innerHTML = `
    <div class="bg-[#1a1a1a] p-6 rounded-lg border border-[#2a2a2a]">
      <h2 class="text-lg font-semibold mb-4 flex items-center"><span class="mr-2">ðŸ’¡</span> Key Insights</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        ${i.map(x => `<div class="bg-[#0a0a0a] p-4 rounded border border-[#2a2a2a]"><p class="text-sm text-gray-300">${x}</p></div>`).join('')}
      </div>
    </div>`;
}

function buildMetrics() {
  const t = rawData.trades;

  // NET totals
  const net = t.reduce((s, x) => s + getNetPnL(x), 0);
  const wins = t.filter(x => getNetPnL(x) > 0);
  const losses = t.filter(x => getNetPnL(x) < 0);

  const wr = t.length ? (wins.length / t.length) * 100 : 0;

  // Profit Factor (NET)
  const grossProfitNet = wins.reduce((s, x) => s + getNetPnL(x), 0);
  const grossLossNetAbs = Math.abs(losses.reduce((s, x) => s + getNetPnL(x), 0));
  const pf = grossLossNetAbs > 0 ? (grossProfitNet / grossLossNetAbs) : 0;

  const curBal = rawData.startingBalance + net;

  const m = [
    { l: 'Net Return', v: formatMoney(net), c: net >= 0 ? 'text-green-400' : 'text-red-400' },
    { l: 'Win Rate', v: wr.toFixed(2) + '%', c: wr >= 50 ? 'text-green-400' : 'text-red-400', visual: true, p: wr },
    { l: 'Avg P&L', v: formatMoney(t.length ? net / t.length : 0), c: net >= 0 ? 'text-green-400' : 'text-red-400' },
    { l: 'Profit Factor', v: pf.toFixed(2), c: pf >= 1 ? 'text-green-400' : 'text-red-400' },
    { l: 'Balance', v: '$' + curBal.toFixed(2), c: 'text-white', sub: `${((net / rawData.startingBalance) * 100).toFixed(2)}% ROI` }
  ];

  document.getElementById('metricsContainer').innerHTML = m.map(i => `
    <div class="metric-card p-4 rounded-lg border border-[#2a2a2a]">
      <p class="text-xs text-gray-500 uppercase font-bold mb-1">${i.l}</p>
      ${i.visual ? `
        <div class="flex justify-between items-center">
          <p class="text-2xl font-bold ${i.c}">${i.v}</p>
          <svg class="w-10 h-10 -rotate-90">
            <circle cx="20" cy="20" r="16" stroke="#333" stroke-width="3" fill="none"/>
            <circle cx="20" cy="20" r="16" stroke="${i.p >= 50 ? '#10b981' : '#ef4444'}" stroke-width="3" fill="none"
              stroke-dasharray="${100.5 * i.p / 100} 100.5"></circle>
          </svg>
        </div>` : `<p class="text-2xl font-bold ${i.c}">${i.v}</p>`}
      ${i.sub ? `<p class="text-xs text-gray-500 mt-1">${i.sub}</p>` : ''}
    </div>`).join('');
}

function buildEvaluationPanel() {
  const t = rawData.trades;
  const meta = rawData.metadata || {};

  // Day-level NET for winning/losing days
  const dayNet = new Map();
  t.forEach(x => dayNet.set(x.date, (dayNet.get(x.date) || 0) + getNetPnL(x)));
  const winningDays = [...dayNet.values()].filter(v => v > 0).length;
  const losingDays = [...dayNet.values()].filter(v => v < 0).length;

  // Trade-level NET win/loss
  const wins = t.filter(x => getNetPnL(x) > 0);
  const losses = t.filter(x => getNetPnL(x) < 0);

  const totalMins = t.reduce((s, x) => s + getHoldTime(x), 0);
  const avgHold = t.length ? (totalMins / t.length).toFixed(0) : 0;

  const activeTrades = wins.length + losses.length;
  const realWr = activeTrades ? ((wins.length / activeTrades) * 100).toFixed(2) : '0.00';

  const net = t.reduce((s, x) => s + getNetPnL(x), 0);
  const roi = ((net / rawData.startingBalance) * 100).toFixed(2);

  const uniqueDays = dayNet.size;
  const tpd = uniqueDays ? (t.length / uniqueDays).toFixed(1) : 0;
  const tpw = uniqueDays ? (t.length / (uniqueDays / 5)).toFixed(1) : 0;

  // Streak based on NET
  let streakHtml = [];
  const recent = t.slice(0, 5).reverse();
  for (let i = 0; i < recent.length; i++) {
    const p = getNetPnL(recent[i]);
    if (p > 0) streakHtml.push('<span class="text-green-400 font-bold mx-1">W</span>');
    else if (p < 0) streakHtml.push('<span class="text-red-400 font-bold mx-1">L</span>');
    else streakHtml.push('<span class="text-gray-500 mx-1">B</span>');
  }

  const rows = [
    { l: 'Total Number of Trades', v: t.length },
    { l: 'Avg. Profit per Trading Day', v: formatMoney(meta.avgPL || 0), c: (meta.avgPL || 0) >= 0 ? 'text-green-400' : 'text-red-400' },
    { l: 'Biggest Winner', v: formatMoney(meta.biggestWinner || 0), c: 'text-green-400' },
    { l: 'Biggest Loser', v: formatMoney(meta.biggestLoser || 0), c: 'text-red-400' },
    { l: 'Total Fees', v: `$${parseFloat(meta.totalFees || 0).toFixed(2)}` },
    { l: 'Avg. Hold Time (Minutes)', v: `${avgHold}` },
    { l: 'Winrate w/o BE', v: `${realWr}%` },
    { l: 'ROI', v: `${roi}%`, c: roi >= 0 ? 'text-green-400' : 'text-red-400' },
    { l: 'Max Drawdown', v: `${parseFloat(meta.maxDrawdownPercent || 0).toFixed(2)}%`, c: 'text-red-400' },
    { l: 'Winning / Losing Days', v: `${winningDays} / ${losingDays}` },
    { l: 'Trades Per Day / Week', v: `${tpd} / ${tpw}` },
    { l: 'Current Streak', v: streakHtml.join('') }
  ];

  document.getElementById('evaluationPanel').innerHTML = rows.map(r => `
    <div class="flex justify-between items-center py-3 px-2 hover:bg-[#222]">
      <span class="text-gray-400 text-sm font-medium">${r.l}</span>
      <span class="text-sm ${r.c || 'text-white'}">${r.v}</span>
    </div>
  `).join('');
}

let calYear = new Date().getFullYear(), calMonth = new Date().getMonth();

function renderCalendar() {
  const mNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  document.getElementById('calendarMonthYear').textContent = `${mNames[calMonth]} ${calYear}`;

  const firstDay = new Date(calYear, calMonth, 1).getDay();
  const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
  const offset = firstDay === 0 ? 6 : firstDay - 1;
  const today = new Date();
  const isCurrentMonth = today.getFullYear() === calYear && today.getMonth() === calMonth;
  const currentDay = today.getDate();

  let html = '';
  let weekTrades = 0, weekPnL = 0;

  for (let i = 0; i < offset; i++) html += `<div class="h-14 md:h-20 bg-[#111] border border-[#222] rounded-lg"></div>`;

  for (let d = 1; d <= daysInMonth; d++) {
    const dateStr = `${calYear}-${String(calMonth + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
    const dayTrades = rawData.trades.filter(t => t.date === dateStr);

    // NET day pnl
    const dayPnL = dayTrades.reduce((s, t) => s + getNetPnL(t), 0);

    weekTrades += dayTrades.length;
    weekPnL += dayPnL;

    let bg = 'bg-[#151515]', border = 'border-[#2a2a2a]', txt = 'text-gray-500';
    if (dayTrades.length) {
      bg = dayPnL >= 0 ? 'bg-green-900/10' : 'bg-red-900/10';
      border = dayPnL >= 0 ? 'border-green-900/40' : 'border-red-900/40';
      txt = dayPnL >= 0 ? 'text-green-400' : 'text-red-400';
    }
    const isToday = isCurrentMonth && d === currentDay ? 'current-day' : '';

    let tooltip = '';
    if (dayTrades.length) {
      tooltip = `<div class="calendar-tooltip">
        <div class="tooltip-header flex justify-between"><span>${dateStr}</span><span>${formatMoney(dayPnL)}</span></div>
        <div class="tooltip-body space-y-1">`;
      dayTrades.forEach(t => {
        const tp = getNetPnL(t);
        tooltip += `<div onclick="event.stopPropagation(); openTradeModal('${t.trade_id}')" class="flex justify-between hover:bg-[#333] p-1.5 rounded cursor-pointer text-xs">
          <span class="font-bold text-gray-300">${t.symbol}</span><span class="${tp >= 0 ? 'text-green-400' : 'text-red-400'}">${formatMoney(tp)}</span>
        </div>`;
      });
      tooltip += `</div></div>`;
    }

    html += `<div class="calendar-day h-14 md:h-20 rounded-lg ${border} ${bg} ${isToday} flex flex-col items-center justify-center relative group">
      <span class="text-[10px] md:text-xs font-bold text-gray-500 absolute top-1 right-2">${d}</span>
      ${dayTrades.length ? `<span class="text-xs md:text-sm font-bold ${txt}">${formatMoney(dayPnL)}</span><span class="text-[9px] md:text-[10px] text-gray-500 hide-mobile">${dayTrades.length}t</span>` : ''}
      ${tooltip}
    </div>`;

    const dayOfWeek = new Date(calYear, calMonth, d).getDay();
    if (dayOfWeek === 0 || d === daysInMonth) {
      let wHtml = `<div class="h-14 md:h-20 bg-transparent border border-transparent rounded-lg"></div>`;
      if (weekTrades > 0) {
        const isProfit = weekPnL >= 0;
        const wBg = isProfit ? 'bg-green-900/10' : 'bg-red-900/10';
        const wBorder = isProfit ? 'border-green-900/40' : 'border-red-900/40';
        const wTxt = isProfit ? 'text-green-400' : 'text-red-400';
        wHtml = `<div class="h-14 md:h-20 rounded-lg border ${wBorder} ${wBg} flex flex-col items-center justify-center relative week-total">
          <span class="text-[8px] md:text-[9px] uppercase text-gray-500 font-bold mb-1 opacity-70">Week</span>
          <span class="text-xs md:text-sm font-bold ${wTxt}">${formatMoney(weekPnL)}</span>
          <span class="text-[9px] md:text-[10px] text-gray-500 hide-mobile">${weekTrades}t</span>
        </div>`;
      }
      html += wHtml;
      weekTrades = 0; weekPnL = 0;
    }
  }
  document.getElementById('calendarGrid').innerHTML = html;
}

window.changeCalendarMonth = (d) => {
  calMonth += d;
  if (calMonth > 11) { calMonth = 0; calYear++; }
  if (calMonth < 0) { calMonth = 11; calYear--; }
  renderCalendar();
};

function initCharts() {
  Chart.defaults.color = '#666';
  Chart.defaults.borderColor = '#2a2a2a';

  const ctx = document.getElementById('equityChart').getContext('2d');
  equityChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Equity',
        data: [],
        fill: { target: { value: rawData.startingBalance }, above: 'rgba(16, 185, 129, 0.1)', below: 'rgba(239, 68, 68, 0.1)' },
        segment: { borderColor: c => c.p0.parsed.y >= rawData.startingBalance ? '#10b981' : '#ef4444' },
        tension: 0.3,
        pointRadius: 0,
        pointHoverRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
      scales: { x: { grid: { display: false } }, y: { border: { display: false } } },
      interaction: { mode: 'nearest', axis: 'x', intersect: false }
    }
  });

  switchEquityView('trades');

  // Time Analysis (NET)
  new Chart(document.getElementById('timeAnalysisChart'), {
    type: 'bar',
    data: {
      labels: Object.keys(rawData.hours).sort((a,b)=>parseInt(a)-parseInt(b)).map(k => k + ':00'),
      datasets: [{
        data: Object.keys(rawData.hours).sort((a,b)=>parseInt(a)-parseInt(b)).map(k => rawData.hours[k].pnl),
        backgroundColor: Object.keys(rawData.hours).sort((a,b)=>parseInt(a)-parseInt(b)).map(k => rawData.hours[k].pnl >= 0 ? '#10b981' : '#ef4444')
      }]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
  });

  // Weekday (NET) â€“ chart Mon-Fri
  const wDays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
  new Chart(document.getElementById('weekdayChart'), {
    type: 'bar',
    data: {
      labels: wDays,
      datasets: [{
        data: wDays.map(d => (rawData.weekdays[d] || {}).pnl || 0),
        backgroundColor: wDays.map(d => ((rawData.weekdays[d] || {}).pnl || 0) >= 0 ? '#10b981' : '#ef4444')
      }]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
  });
}

function displayTrades(page = 1) {
  const start = (page - 1) * tradesPerPage;
  const end = Math.min(start + tradesPerPage, filteredTrades.length);
  const show = filteredTrades.slice(start, end);

  document.getElementById('tradesTableBody').innerHTML = show.map(t => {
    const { full } = driveUrls(t.screenshot || t.screenshot_url_A);

    const pnl = getNetPnL(t); // NET
    const balance = t.runningBalance || 0;

    return `<tr class="trade-row border-b border-[#2a2a2a] transition-colors" onclick="openTradeModal('${t.trade_id}')">
      <td class="py-3 px-4 text-left font-mono text-sm text-blue-400 hover:underline">${t.trade_id}</td>
      <td class="py-3 px-4 text-left text-sm text-gray-300">${t.date}</td>
      <td class="py-3 px-4 text-left text-sm font-medium">${t.symbol}</td>
      <td class="py-3 px-4 text-left hide-mobile"><span class="px-2 py-1 text-xs rounded ${t.side?.toLowerCase().includes('long') ? 'bg-green-900 text-green-200' : 'bg-red-900 text-red-200'}">${t.side}</span></td>
      <td class="py-3 px-4 text-left hide-mobile text-sm text-gray-300 font-mono">${parseFloat(t.entry_price).toFixed(2)}</td>
      <td class="py-3 px-4 text-left hide-mobile text-sm text-gray-300 font-mono">${parseFloat(t.exit_price).toFixed(2)}</td>
      <td class="py-3 px-4 text-right text-sm font-bold ${pnl >= 0 ? 'text-green-400' : 'text-red-400'}">${formatMoney(pnl)}</td>
      <td class="py-3 px-4 text-right hide-mobile text-sm text-gray-300">$${balance.toFixed(2)}</td>
      <td class="py-3 px-4 text-center" onclick="event.stopPropagation()">
        ${full ? `<div class="screenshot-link" onclick="openTradeModal('${t.trade_id}')"><span class="text-xs bg-[#333] px-2 py-1 rounded hover:bg-white hover:text-black transition-colors cursor-pointer">IMG</span></div>` : '<span class="text-gray-500">-</span>'}
      </td>
    </tr>`;
  }).join('');

  document.getElementById('paginationInfo').textContent = `Showing ${start + 1}-${end} of ${filteredTrades.length}`;
  document.getElementById('prevPage').disabled = page <= 1;
  document.getElementById('nextPage').disabled = page >= Math.ceil(filteredTrades.length / tradesPerPage);
  currentPage = page;
}

function openTradeModal(id) {
  const idx = allTrades.findIndex(t => t.trade_id === id);
  if (idx === -1) return;
  currentTradeIndex = idx;
  renderModalContent();
  document.getElementById('tradeModal').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
  modalOpen = true;
}

function closeModal() {
  document.getElementById('tradeModal').classList.add('hidden');
  document.body.style.overflow = '';
  modalOpen = false;
}

function navigateTrade(d) {
  if (!modalOpen) return;
  const n = currentTradeIndex + d;
  if (n >= 0 && n < allTrades.length) { currentTradeIndex = n; renderModalContent(); }
}

function renderModalContent() {
  const t = allTrades[currentTradeIndex];
  if (!t) return;

  document.getElementById('m_tradeId').textContent = t.trade_id;
  document.getElementById('m_tradeId_mob').textContent = t.trade_id;
  document.getElementById('m_date').textContent = t.date;
  document.getElementById('m_date_mob').textContent = t.date;
  document.getElementById('m_time').textContent = t.entry_time;
  document.getElementById('m_symbol').textContent = t.symbol;
  document.getElementById('m_symbol_mob').textContent = t.symbol;
  document.getElementById('m_side').textContent = t.side;

  document.getElementById('m_side').className =
    `px-2 py-1 rounded text-xs font-bold ml-2 uppercase ${t.side?.toLowerCase().includes('long') ? 'bg-green-900 text-green-200' : 'bg-red-900 text-red-200'}`;

  const pnl = getNetPnL(t); // NET
  document.getElementById('m_pnl').textContent = formatMoney(pnl);
  document.getElementById('m_pnl').className = `text-2xl font-bold leading-none mt-1 ${pnl >= 0 ? 'text-green-400' : 'text-red-400'}`;
  document.getElementById('m_pnl_mob').textContent = formatMoney(pnl);
  document.getElementById('m_pnl_mob').className = `text-xl font-bold ${pnl >= 0 ? 'text-green-400' : 'text-red-400'}`;

  document.getElementById('m_entry_price').textContent = parseFloat(t.entry_price).toFixed(2);
  document.getElementById('m_exit_price').textContent = parseFloat(t.exit_price).toFixed(2);
  document.getElementById('m_setup').textContent = t.setup || '-';
  document.getElementById('m_session').textContent = t.session || '-';
  document.getElementById('m_score').textContent = t.score || t['Total Score'] || '-';
  document.getElementById('m_notes').textContent = t.notes || 'No notes.';

  const { full } = driveUrls(t.screenshot || t.screenshot_url_A);
  const img = document.getElementById('m_image'), no = document.getElementById('m_no_image'), lnk = document.getElementById('m_full_link');
  if (full) { img.src = full; img.classList.remove('hidden'); no.classList.add('hidden'); lnk.href = full; lnk.classList.remove('opacity-0'); }
  else { img.classList.add('hidden'); no.classList.remove('hidden'); lnk.classList.add('opacity-0'); }

  const setTag = (id, v) => {
    const el = document.getElementById(id);
    el.textContent = v || '-';
    el.className = 'process-tag ' + (v?.match(/follow|complete/i) ? 'tag-green' : v?.match(/fail|no|impulse/i) ? 'tag-red' : 'tag-gray');
  };
  setTag('m_tag_pre', t.pre_trade);
  setTag('m_tag_entry', t.trade_entry);
  setTag('m_tag_mgmt', t.trade_management);
  setTag('m_tag_exit', t.trade_exit);
}

window.filterTrades = () => {
  const q = document.getElementById('tradeSearch').value.toLowerCase();
  const type = document.getElementById('tradeFilter').value;

  filteredTrades = allTrades.filter(t => {
    const matchesText = (t.symbol?.toLowerCase().includes(q) || t.notes?.toLowerCase().includes(q));
    const net = getNetPnL(t);
    const matchesType = (type === '' ? true : type === 'win' ? net > 0 : net < 0);
    return matchesText && matchesType;
  });

  displayTrades(1);
};

window.changePage = (d) => {
  const max = Math.ceil(filteredTrades.length / tradesPerPage);
  const next = currentPage + d;
  if (next >= 1 && next <= max) displayTrades(next);
};

window.switchEquityView = (mode) => {
  const d = mode === 'days' ? rawData.equityDays : rawData.equityTrades;
  equityChart.data.labels = d.map(x => mode === 'days' ? x.date : 'T' + x.trade);
  equityChart.data.datasets[0].data = d.map(x => x.equity);
  equityChart.update();

  document.getElementById('equityByTrades').className =
    mode === 'trades' ? 'px-3 py-1 text-sm rounded bg-[#2a2a2a]' : 'px-3 py-1 text-sm rounded bg-[#1a1a1a] text-gray-400';
  document.getElementById('equityByDays').className =
    mode === 'days' ? 'px-3 py-1 text-sm rounded bg-[#2a2a2a]' : 'px-3 py-1 text-sm rounded bg-[#1a1a1a] text-gray-400';
};

document.addEventListener('keydown', e => {
  if (modalOpen) {
    if (e.key === 'ArrowLeft') navigateTrade(-1);
    if (e.key === 'ArrowRight') navigateTrade(1);
    if (e.key === 'Escape') closeModal();
  } else {
    if (e.key.toLowerCase() === 'r') location.reload();
  }
});
</script>
