// ════════════════════════════════════════════════════════════════════════════════
// 🚀 PROFESSIONAL TRADING DASHBOARD V3.2 - ENHANCED WITH CALENDAR NAV & DUAL EQUITY
// ════════════════════════════════════════════════════════════════════════════════
// Enhanced with calendar navigation and dual equity curves (by trades/by days)

try {
  // ═══════════════════════════════════════════════════════════════════════════════
  // 📊 DATA PROCESSING & VALIDATION
  // ═══════════════════════════════════════════════════════════════════════════════
  
  const items = $input.all();
  let trades = items.map(item => item.json).filter(trade => 
    trade.trade_id && 
    trade.trade_id.trim() !== '' && 
    trade.trade_id !== 'trade_id' // Remove header row if present
  );

  // Handle empty data scenario
  if (trades.length === 0) {
    return [{
      json: {
        html: `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>body { margin: 0; background-color: #0a0a0a; }</style>
</head>
<body class="bg-[#0a0a0a] text-white p-6">
    <div class="max-w-4xl mx-auto text-center">
        <div class="bg-[#1a1a1a] p-8 rounded-lg border border-[#2a2a2a]">
            <div class="mb-6">
                <div class="w-16 h-16 bg-[#2a2a2a] rounded-full mx-auto mb-4 flex items-center justify-center">
                    <span class="text-2xl">📊</span>
                </div>
                <h1 class="text-2xl font-bold text-white mb-2">No Trading Data Found</h1>
                <p class="text-gray-400 mb-6">Please add some trades to your Google Sheets to see the dashboard.</p>
            </div>
            <div class="bg-blue-900/30 border border-blue-600/50 p-4 rounded-lg">
                <p class="text-blue-200 text-sm">
                    💡 <strong>Next Steps:</strong><br>
                    1. Upload CSV trades via Telegram bot<br>
                    2. Refresh this page to see your dashboard<br>
                    3. Dashboard will show all your trading metrics and charts
                </p>
            </div>
        </div>
    </div>
</body>
</html>`
      }
    }];
  }

  // ═══════════════════════════════════════════════════════════════════════════════
  // 🧮 CORE METRICS CALCULATION
  // ═══════════════════════════════════════════════════════════════════════════════
  
  // Helper function to parse monetary values
  const parseMoneyValue = (value) => {
    if (!value && value !== 0) return 0;
    if (typeof value === 'number') return value;
    const cleanValue = value.toString().trim().replace(/[$,]/g, '');
    const parsed = parseFloat(cleanValue);
    return isNaN(parsed) ? 0 : parsed;
  };
  
  // Helper function to convert Google Drive links to direct image links
  const convertGoogleDriveLink = (url) => {
    if (!url) return null;
    const match = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
    if (match && match[1]) {
      return `https://drive.google.com/uc?export=view&id=${match[1]}`;
    }
    return url; // Return original if not a Google Drive link
  };
  
  // Sort trades by date for proper balance calculation
  trades.sort((a, b) => {
    const dateA = new Date(a.date + ' ' + (a.entry_time || '00:00'));
    const dateB = new Date(b.date + ' ' + (b.entry_time || '00:00'));
    return dateA - dateB;
  });

  // Calculate dynamic starting balance early so we can use it throughout
  const startingBalance = trades.length > 0 && trades[0].Balance ? 
    parseMoneyValue(trades[0].Balance) - parseMoneyValue(trades[0]['p_l']) : 
    50000;

  const totalTrades = trades.length;
  const netPL = trades.reduce((sum, trade) => sum + parseMoneyValue(trade['p_l']), 0);
  const winningTrades = trades.filter(trade => parseMoneyValue(trade['p_l']) > 0);
  const losingTrades = trades.filter(trade => parseMoneyValue(trade['p_l']) < 0);
  const breakEvenTrades = trades.filter(trade => parseMoneyValue(trade['p_l']) === 0);
  
  // Fee calculation
  const totalFees = trades.reduce((sum, trade) => sum + parseMoneyValue(trade.fees || trade.fee || 0), 0);
  const netPLAfterFees = netPL - totalFees; // Updated to include fees in net return
  
  // Get current balance from last trade's Balance column
  const currentBalance = trades.length > 0 && trades[trades.length - 1].Balance ? 
    parseMoneyValue(trades[trades.length - 1].Balance) : startingBalance + netPLAfterFees;
  
  const winRate = totalTrades > 0 ? (winningTrades.length / totalTrades * 100) : 0;
  const avgPL = totalTrades > 0 ? netPLAfterFees / totalTrades : 0; // Updated to use net P&L after fees
  const biggestWinner = Math.max(...trades.map(t => parseMoneyValue(t['p_l'])), 0);
  const biggestLoser = Math.min(...trades.map(t => parseMoneyValue(t['p_l'])), 0);

  // Advanced metrics
  const totalWins = winningTrades.reduce((sum, t) => sum + parseMoneyValue(t['p_l']), 0);
  const totalLosses = Math.abs(losingTrades.reduce((sum, t) => sum + parseMoneyValue(t['p_l']), 0));
  const profitFactor = totalLosses > 0 ? totalWins / totalLosses : (totalWins > 0 ? 999 : 0);
  
  const avgWin = winningTrades.length > 0 ? totalWins / winningTrades.length : 0;
  const avgLoss = losingTrades.length > 0 ? totalLosses / losingTrades.length : 0;
  const rrRatio = avgLoss > 0 ? avgWin / avgLoss : (avgWin > 0 ? 999 : 0);

  // ═══════════════════════════════════════════════════════════════════════════════
  // 📈 PERFORMANCE ANALYSIS BY CATEGORIES
  // ═══════════════════════════════════════════════════════════════════════════════

  // Performance by symbol
  const symbolData = trades.reduce((acc, trade) => {
    const symbol = trade.symbol || 'UNKNOWN';
    const pnl = parseMoneyValue(trade['p_l']);
    if (!acc[symbol]) acc[symbol] = { pnl: 0, trades: 0, wins: 0 };
    acc[symbol].pnl += pnl;
    acc[symbol].trades += 1;
    if (pnl > 0) acc[symbol].wins += 1;
    return acc;
  }, {});

  // Performance by weekday
  const weekdayData = trades.reduce((acc, trade) => {
    const date = new Date(trade.date);
    const weekday = date.toLocaleDateString('en-US', { weekday: 'long' });
    const pnl = parseMoneyValue(trade['p_l']);
    if (!acc[weekday]) acc[weekday] = { pnl: 0, trades: 0 };
    acc[weekday].pnl += pnl;
    acc[weekday].trades += 1;
    return acc;
  }, {});

  // Performance by hour
  const hourData = trades.reduce((acc, trade) => {
    const hour = parseInt((trade.entry_time || '0:0').split(':')[0]) || 0;
    const pnl = parseMoneyValue(trade['p_l']);
    if (!acc[hour]) acc[hour] = { pnl: 0, trades: 0 };
    acc[hour].pnl += pnl;
    acc[hour].trades += 1;
    return acc;
  }, {});

  // ═══════════════════════════════════════════════════════════════════════════════
  // 📅 CALENDAR DATA GENERATION WITH TRADE DETAILS
  // ═══════════════════════════════════════════════════════════════════════════════

  const now = new Date();
  const currentMonth = now.getMonth();
  const currentYear = now.getFullYear();
  
  // Store all monthly data for navigation
  const monthlyData = {};
  
  // Process all trades and organize by month
  trades.forEach(trade => {
    const tradeDate = new Date(trade.date);
    const day = tradeDate.getDate();
    const month = tradeDate.getMonth();
    const year = tradeDate.getFullYear();
    const monthKey = `${year}-${month}`;
    
    if (!monthlyData[monthKey]) {
      monthlyData[monthKey] = {};
    }
    
    if (!monthlyData[monthKey][day]) {
      monthlyData[monthKey][day] = { pnl: 0, trades: 0, tradeDetails: [] };
    }
    
    monthlyData[monthKey][day].pnl += parseMoneyValue(trade['p_l']);
    monthlyData[monthKey][day].trades += 1;
    monthlyData[monthKey][day].tradeDetails.push({
      symbol: trade.symbol,
      pnl: parseMoneyValue(trade['p_l']),
      side: trade.side,
      time: trade.entry_time || '00:00'
    });
  });
  
  // Current month data for initial display
  const dailyPnL = monthlyData[`${currentYear}-${currentMonth}`] || {};

  // Generate calendar cells with hover functionality
  const generateCalendarCells = (year, month, data) => {
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const firstDay = new Date(year, month, 1).getDay();
    const today = now.getDate();
    const isCurrentMonth = year === currentYear && month === currentMonth;
    
    let cells = '';
    
    // Empty cells before month starts
    for (let i = 0; i < (firstDay === 0 ? 6 : firstDay - 1); i++) {
      cells += '<div class="h-16 rounded border border-[#2a2a2a] bg-[#0a0a0a]"></div>';
    }
    
    // Days of the month with hover functionality
    for (let day = 1; day <= daysInMonth; day++) {
      const dayData = data[day];
      const isToday = isCurrentMonth && day === today;
      
      let cellClass = 'calendar-day h-16 rounded border flex flex-col items-center justify-center text-sm relative cursor-pointer ';
      if (dayData && dayData.pnl > 0) {
        cellClass += 'bg-green-900/30 border-green-600/50';
      } else if (dayData && dayData.pnl < 0) {
        cellClass += 'bg-red-900/30 border-red-600/50';
      } else {
        cellClass += 'bg-[#1a1a1a] border-[#2a2a2a]';
      }
      
      if (isToday) {
        cellClass += ' ring-2 ring-blue-400';
      }
      
      // Generate tooltip content
      let tooltipContent = '';
      if (dayData && dayData.tradeDetails.length > 0) {
        tooltipContent = `
          <div class="calendar-tooltip">
            <div class="font-semibold mb-2">${new Date(year, month, day).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
            <div class="text-xs space-y-1">
              ${dayData.tradeDetails.map(trade => `
                <div class="flex justify-between items-center">
                  <span>${trade.symbol} ${trade.side === 'Long' || trade.side === 'BUY' ? '↑' : '↓'}</span>
                  <span class="${trade.pnl >= 0 ? 'text-green-400' : 'text-red-400'}">
                    ${trade.pnl >= 0 ? '+' : ''}${trade.pnl.toFixed(0)}
                  </span>
                </div>
              `).join('')}
              <div class="border-t border-[#3a3a3a] pt-1 mt-1 font-semibold flex justify-between">
                <span>Total:</span>
                <span class="${dayData.pnl >= 0 ? 'text-green-400' : 'text-red-400'}">
                  ${dayData.pnl >= 0 ? '+' : ''}${dayData.pnl.toFixed(0)}
                </span>
              </div>
            </div>
          </div>
        `;
      }
      
      cells += `<div class="${cellClass}" ${dayData ? `data-day="${day}"` : ''}>
        <span class="text-white font-medium">${day}</span>`;
      
      if (dayData) {
        cells += `<span class="text-xs ${dayData.pnl >= 0 ? 'text-green-400' : 'text-red-400'}">
          ${dayData.pnl >= 0 ? '+' : ''}${dayData.pnl.toFixed(0)}
        </span>
        <span class="text-xs text-gray-500">${dayData.trades}t</span>
        ${tooltipContent}`;
      }
      
      if (isToday && !dayData) {
        cells += '<span class="text-blue-400 text-xs">Today</span>';
      }
      
      cells += '</div>';
    }
    
    return cells;
  };

  // ═══════════════════════════════════════════════════════════════════════════════
  // 📊 EQUITY CURVE CALCULATION
  // ═══════════════════════════════════════════════════════════════════════════════

  // Note: startingBalance is calculated earlier in the code dynamically
  const equityData = [
    // Add initial starting balance point
    {
      trade: 0,
      equity: startingBalance,
      date: 'Starting Balance',
      pnl: 0
    },
    // Then map all trades
    ...trades.map((trade, index) => {
      // Use actual Balance from spreadsheet if available, otherwise calculate
      const balance = trade.Balance ? 
        parseMoneyValue(trade.Balance) : 
        startingBalance + trades.slice(0, index + 1).reduce((sum, t) => sum + parseMoneyValue(t['p_l']), 0);
      
      return {
        trade: index + 1,
        equity: balance,
        date: trade.date,
        pnl: parseMoneyValue(trade['p_l'])
      };
    })
  ];

  // Daily equity curve calculation
  const dailyEquityData = [];
  const dailyPnLMap = new Map();
  
  // Group trades by day and calculate cumulative P&L
  trades.forEach(trade => {
    const date = trade.date;
    if (!dailyPnLMap.has(date)) {
      dailyPnLMap.set(date, 0);
    }
    dailyPnLMap.set(date, dailyPnLMap.get(date) + parseMoneyValue(trade['p_l']));
  });
  
  // Convert to array and sort by date
  const sortedDays = Array.from(dailyPnLMap.entries()).sort((a, b) => new Date(a[0]) - new Date(b[0]));
  
  // Create daily equity curve
  dailyEquityData.push({
    day: 0,
    equity: startingBalance,
    date: 'Starting Balance',
    pnl: 0
  });
  
  let cumulativeBalance = startingBalance;
  sortedDays.forEach((entry, index) => {
    const [date, dayPnL] = entry;
    cumulativeBalance += dayPnL;
    dailyEquityData.push({
      day: index + 1,
      equity: cumulativeBalance,
      date: date,
      pnl: dayPnL
    });
  });

  // Drawdown calculation
  let peak = startingBalance;
  let maxDrawdown = 0;
  equityData.forEach(point => {
    if (point.equity > peak) peak = point.equity;
    const drawdown = peak - point.equity;
    if (drawdown > maxDrawdown) maxDrawdown = drawdown;
  });

  const maxDrawdownPercent = peak > 0 ? (maxDrawdown / peak * 100) : 0;

  // ═══════════════════════════════════════════════════════════════════════════════
  // 🎨 CONFIGURATION OPTIONS
  // ═══════════════════════════════════════════════════════════════════════════════

  const CONFIG = {
    autoRefresh: true,              
    autoRefreshInterval: 5,         
    showAdvancedMetrics: true,      
    showSetupAnalysis: true,        
    showCalendar: true,             
    showEquityCurve: true,          
    enableNotifications: false,     
    darkMode: true,                 
    compactMode: false,             
    showLastUpdateTime: true,       
    animateCharts: true,           
    enableKeyboardShortcuts: true, 
    showDebugInfo: false,
    showScreenshots: true,
    tradesPerPage: 15              // For pagination
  };

  // ═══════════════════════════════════════════════════════════════════════════════
  // 🎯 INSIGHTS & RECOMMENDATIONS GENERATOR
  // ═══════════════════════════════════════════════════════════════════════════════

  const generateInsights = () => {
    const insights = [];
    
    // Win rate insights
    if (winRate > 70) {
      insights.push("🎯 Excellent win rate! Consider increasing position size on high-confidence setups.");
    } else if (winRate < 40) {
      insights.push("⚠️ Win rate below 40% - review entry criteria and setup selection.");
    } else if (winRate >= 50) {
      insights.push("✅ Solid win rate - focus on improving risk/reward ratio.");
    }
    
    // Risk management insights
    if (Math.abs(biggestLoser) > biggestWinner * 2) {
      insights.push("🛡️ Largest loss is disproportionate - tighten risk management rules.");
    }
    
    // Profit factor insights
    if (profitFactor > 2) {
      insights.push("💪 Excellent profit factor - your edge is strong!");
    } else if (profitFactor < 1) {
      insights.push("📉 Profit factor below 1 - review strategy effectiveness.");
    }
    
    // Symbol performance insights
    const bestSymbol = Object.entries(symbolData)
      .sort(([,a], [,b]) => b.pnl - a.pnl)[0];
    if (bestSymbol && bestSymbol[1].pnl > 0) {
      insights.push(`🏆 ${bestSymbol[0]} is your strongest performer (+$${bestSymbol[1].pnl.toFixed(2)} over ${bestSymbol[1].trades} trades).`);
    }
    
    // Consistency insights
    let profitableDays = 0;
    let totalTradingDays = 0;
    Object.values(monthlyData).forEach(monthData => {
      Object.values(monthData).forEach(day => {
        totalTradingDays++;
        if (day.pnl > 0) profitableDays++;
      });
    });
    
    if (totalTradingDays > 0) {
      const dayWinRate = (profitableDays / totalTradingDays * 100);
      if (dayWinRate > 60) {
        insights.push("📈 Strong daily consistency - most trading days are profitable.");
      }
    }
    
    return insights;
  };

  const insights = generateInsights();

  // ═══════════════════════════════════════════════════════════════════════════════
  // 🌐 HTML DASHBOARD GENERATION - ENHANCED VERSION
  // ═══════════════════════════════════════════════════════════════════════════════

  const dashboardHTML = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Dashboard - ${new Date().toLocaleDateString()}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📊</text></svg>">
    <style>
        /* Edgewonk Dark Theme */
        body { 
            margin: 0; 
            background-color: #0a0a0a;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        .metric-card { 
            transition: all 0.3s ease;
            background-color: #1a1a1a;
            border: 1px solid #2a2a2a;
        }
        .metric-card:hover { 
            transform: translateY(-2px);
            border-color: #3a3a3a;
        }
        .chart-container { 
            position: relative; 
            height: 300px; 
            width: 100%;
        }
        .live-indicator { animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Calendar hover styles */
        .calendar-day {
            position: relative;
            transition: all 0.2s ease;
        }
        .calendar-day:hover {
            transform: scale(1.05);
            z-index: 10;
        }
        .calendar-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            background: #1a1a1a;
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            padding: 12px;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
            min-width: 200px;
            z-index: 100;
            box-shadow: 0 10px 25px rgba(0,0,0,0.8);
        }
        .calendar-day:hover .calendar-tooltip {
            visibility: visible;
            opacity: 1;
        }
        
        /* Ensure table cells don't overflow */
        td {
            position: relative;
            overflow: visible;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        ::-webkit-scrollbar-thumb {
            background: #3a3a3a;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4a4a4a;
        }
        
        /* Chart grid lines */
        .chart-dark {
            background: #1a1a1a;
        }
        
        /* Pagination buttons */
        .pagination-btn {
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            color: #ffffff;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .pagination-btn:hover:not(:disabled) {
            background: #3a3a3a;
            transform: translateY(-1px);
        }
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
    ${CONFIG.autoRefresh && CONFIG.autoRefreshInterval > 0 ? `
    <script>
        // Auto-refresh dashboard
        setTimeout(() => {
            if (document.visibilityState === 'visible') {
                location.reload();
            }
        }, ${CONFIG.autoRefreshInterval * 60 * 1000});
    </script>
    ` : ''}
</head>
<body class="bg-[#0a0a0a] text-white">
    <div class="min-h-screen bg-[#0a0a0a] text-white p-4 md:p-6">
        <div class="max-w-7xl mx-auto">
            
            <!-- ═══ HEADER ═══ -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold mb-2 flex items-center">
                        Trading Dashboard
                        <span class="live-indicator inline-block w-3 h-3 bg-green-400 rounded-full ml-3"></span>
                    </h1>
                    <div class="flex flex-wrap items-center space-x-4 text-sm text-gray-400">
                        <span>📊 ${totalTrades} Total Trades</span>
                        <span>•</span>
                        <span>💰 Balance: ${currentBalance.toFixed(2)}</span>
                        <span>•</span>
                        <span>📈 Net P&L: ${netPLAfterFees >= 0 ? '' : '-'}${Math.abs(netPLAfterFees).toFixed(2)}</span>
                        <span>•</span>
                        <span>💵 Starting: ${startingBalance.toFixed(2)}</span>
                        ${CONFIG.showLastUpdateTime ? `
                        <span>•</span>
                        <span>🕐 ${new Date().toLocaleTimeString()}</span>
                        ` : ''}
                    </div>
                </div>
                <div class="flex space-x-2 mt-4 md:mt-0">
                    <button onclick="window.location.reload()" 
                            class="bg-[#2a2a2a] hover:bg-[#3a3a3a] px-4 py-2 rounded text-sm font-medium transition-all border border-[#3a3a3a]">
                        🔄 Refresh
                    </button>
                </div>
            </div>

            <!-- ═══ KEY METRICS ═══ -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
                <div class="metric-card p-4 rounded">
                    <p class="text-gray-400 text-xs font-medium uppercase tracking-wider mb-1">Net Return</p>
                    <p class="text-2xl font-bold ${netPLAfterFees >= 0 ? 'text-green-400' : 'text-red-400'}">
                        ${netPLAfterFees >= 0 ? '+' : '-'}$${Math.abs(netPLAfterFees).toFixed(2)}
                    </p>
                    ${totalFees > 0 ? `<p class="text-xs text-gray-500 mt-1">Incl. fees: $${totalFees.toFixed(2)}</p>` : ''}
                </div>

                <div class="metric-card p-4 rounded">
                    <p class="text-gray-400 text-xs font-medium uppercase tracking-wider mb-1">Win Rate</p>
                    <div class="flex items-center justify-between">
                        <p class="text-2xl font-bold ${winRate >= 50 ? 'text-green-400' : 'text-red-400'}">
                            ${winRate.toFixed(1)}%
                        </p>
                        <div class="w-12 h-12 relative">
                            <svg class="w-12 h-12 transform -rotate-90">
                                <circle cx="24" cy="24" r="20" stroke="#2a2a2a" stroke-width="4" fill="none"></circle>
                                <circle cx="24" cy="24" r="20" 
                                        stroke="${winRate >= 50 ? '#10b981' : '#ef4444'}" 
                                        stroke-width="4" 
                                        fill="none"
                                        stroke-dasharray="${125.6 * winRate / 100} 125.6"></circle>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="metric-card p-4 rounded">
                    <p class="text-gray-400 text-xs font-medium uppercase tracking-wider mb-1">Avg P&L</p>
                    <p class="text-2xl font-bold ${avgPL >= 0 ? 'text-green-400' : 'text-red-400'}">
                        ${avgPL >= 0 ? '+' : '-'}$${Math.abs(avgPL).toFixed(2)}
                    </p>
                    ${CONFIG.showAdvancedMetrics ? `
                    <div class="flex space-x-3 mt-1 text-xs">
                        <span class="text-green-400">W: $${avgWin.toFixed(0)}</span>
                        <span class="text-red-400">L: -$${avgLoss.toFixed(0)}</span>
                    </div>
                    ` : ''}
                </div>

                <div class="metric-card p-4 rounded">
                    <p class="text-gray-400 text-xs font-medium uppercase tracking-wider mb-1">Profit Factor</p>
                    <p class="text-2xl font-bold ${profitFactor >= 1 ? 'text-green-400' : 'text-red-400'}">
                        ${profitFactor >= 999 ? '∞' : profitFactor.toFixed(2)}
                    </p>
                    ${CONFIG.showAdvancedMetrics ? `
                    <p class="text-xs text-gray-500 mt-1">R:R ${rrRatio >= 999 ? '∞' : rrRatio.toFixed(1)}</p>
                    ` : ''}
                </div>

                <div class="metric-card p-4 rounded">
                    <p class="text-gray-400 text-xs font-medium uppercase tracking-wider mb-1">Account Balance</p>
                    <p class="text-2xl font-bold text-white">
                        ${currentBalance.toFixed(2)}
                    </p>
                    <p class="text-xs ${netPLAfterFees >= 0 ? 'text-green-400' : 'text-red-400'} mt-1">
                        ${netPLAfterFees >= 0 ? '↑' : '↓'} ${((netPLAfterFees / startingBalance) * 100).toFixed(1)}%
                    </p>
                </div>
            </div>

            <!-- ═══ EQUITY CURVE (MOVED UP) ═══ -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Equity Graph -->
                <div class="bg-[#1a1a1a] p-6 rounded border border-[#2a2a2a] lg:col-span-2">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-semibold">Equity Curve</h2>
                        <div class="flex space-x-2">
                            <button id="equityByTrades" onclick="switchEquityView('trades')" 
                                    class="px-3 py-1 text-sm rounded bg-[#2a2a2a] border border-[#3a3a3a] text-white hover:bg-[#3a3a3a] transition-all">
                                By Trades
                            </button>
                            <button id="equityByDays" onclick="switchEquityView('days')" 
                                    class="px-3 py-1 text-sm rounded bg-[#1a1a1a] border border-[#2a2a2a] text-gray-400 hover:bg-[#2a2a2a] transition-all">
                                By Days
                            </button>
                        </div>
                    </div>
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="equityChart" width="800" height="400"></canvas>
                    </div>
                </div>
            </div>

            <!-- ═══ CALENDAR & EVALUATION ═══ -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <!-- Calendar -->
                <div class="lg:col-span-2">
                    <div class="bg-[#1a1a1a] p-6 rounded border border-[#2a2a2a]">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-lg font-semibold">Profit Calendar</h2>
                            <div class="flex items-center space-x-4">
                                <button onclick="window.changeCalendarMonth(-1)" 
                                        class="p-2 rounded hover:bg-[#2a2a2a] transition-all">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                    </svg>
                                </button>
                                <span class="text-sm text-gray-400" id="calendarMonthYear">
                                    ${new Date(currentYear, currentMonth).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                                </span>
                                <button onclick="window.changeCalendarMonth(1)" 
                                        class="p-2 rounded hover:bg-[#2a2a2a] transition-all">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-7 gap-2 mb-2">
                            ${['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map(day => `
                                <div class="text-center text-gray-500 text-xs font-medium py-2">${day}</div>
                            `).join('')}
                        </div>
                        
                        <div class="grid grid-cols-7 gap-2" id="calendarGrid">
                            ${generateCalendarCells(currentYear, currentMonth, dailyPnL)}
                        </div>
                    </div>
                </div>

                <!-- Evaluation Panel -->
                <div class="bg-[#1a1a1a] p-6 rounded border border-[#2a2a2a]">
                    <h2 class="text-lg font-semibold mb-6">Evaluation</h2>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400 text-sm">Total Number of Trades</span>
                            <span class="font-medium">${totalTrades}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400 text-sm">Avg. Profit per Trading Day</span>
                            <span class="font-medium ${avgPL >= 0 ? 'text-green-400' : 'text-red-400'}">
                                ${avgPL >= 0 ? '+' : '-'}$${Math.abs(avgPL).toFixed(2)}
                            </span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400 text-sm">Biggest Winner</span>
                            <span class="font-medium text-green-400">+$${biggestWinner.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400 text-sm">Biggest Loser</span>
                            <span class="font-medium text-red-400">-$${Math.abs(biggestLoser).toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400 text-sm">Total Fees</span>
                            <span class="font-medium text-gray-300">$${totalFees.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400 text-sm">Win Rate w/o BE</span>
                            <span class="font-medium">${winRate.toFixed(1)}%</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400 text-sm">Max. Drawdown</span>
                            <span class="font-medium text-red-400">${maxDrawdownPercent.toFixed(1)}%</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400 text-sm">Winning / Losing Days</span>
                            <span class="font-medium">
                                ${(() => {
                                    let winDays = 0;
                                    let lossDays = 0;
                                    Object.values(monthlyData).forEach(monthData => {
                                        Object.values(monthData).forEach(day => {
                                            if (day.pnl > 0) winDays++;
                                            else if (day.pnl < 0) lossDays++;
                                        });
                                    });
                                    return `${winDays} / ${lossDays}`;
                                })()}
                            </span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400 text-sm">Trades Per Day / Week</span>
                            <span class="font-medium">
                                ${(() => {
                                    const totalDays = Object.values(monthlyData).reduce((sum, month) => 
                                        sum + Object.keys(month).length, 0);
                                    return `${(totalTrades / Math.max(totalDays, 1)).toFixed(1)} / 
                                    ${(totalTrades / Math.max(totalDays / 5, 1)).toFixed(1)}`;
                                })()}
                            </span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400 text-sm">Current Streak</span>
                            <span class="font-medium text-gray-300">
                                ${(() => {
                                    let streak = 0;
                                    for (let i = trades.length - 1; i >= 0; i--) {
                                        const isWin = parseMoneyValue(trades[i]['p_l']) > 0;
                                        const lastWin = trades.length > 0 ? parseMoneyValue(trades[trades.length - 1]['p_l']) > 0 : false;
                                        if ((lastWin && isWin) || (!lastWin && !isWin)) {
                                            streak++;
                                        } else {
                                            break;
                                        }
                                    }
                                    const type = trades.length > 0 && parseMoneyValue(trades[trades.length - 1]['p_l']) > 0 ? 'W' : 'L';
                                    return `${type}${streak}`;
                                })()}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ═══ CHARTS ═══ -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Performance by Instrument -->
                <div class="bg-[#1a1a1a] p-6 rounded border border-[#2a2a2a]">
                    <h2 class="text-lg font-semibold mb-6">Performance by Instrument</h2>
                    <div class="chart-container">
                        <canvas id="symbolChart" width="400" height="300"></canvas>
                    </div>
                </div>

                <!-- Performance by Weekday -->
                <div class="bg-[#1a1a1a] p-6 rounded border border-[#2a2a2a]">
                    <h2 class="text-lg font-semibold mb-6">Performance by Weekday</h2>
                    <div class="chart-container">
                        <canvas id="weekdayChart" width="400" height="300"></canvas>
                    </div>
                </div>

                <!-- Performance by Hour -->
                <div class="bg-[#1a1a1a] p-6 rounded border border-[#2a2a2a] lg:col-span-2">
                    <h2 class="text-lg font-semibold mb-6">Performance by Hour</h2>
                    <div class="chart-container">
                        <canvas id="hourChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>

            ${insights.length > 0 ? `
            <!-- ═══ INSIGHTS ═══ -->
            <div class="bg-[#1a1a1a] p-6 rounded border border-[#2a2a2a] mb-8">
                <h2 class="text-lg font-semibold mb-4 flex items-center">
                    <span class="mr-2">💡</span> Key Insights
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${insights.map(insight => `
                        <div class="bg-[#0a0a0a] p-4 rounded border border-[#2a2a2a]">
                            <p class="text-sm text-gray-300">${insight}</p>
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}

            <!-- ═══ RECENT TRADES TABLE WITH PAGINATION ═══ -->
            <div class="bg-[#1a1a1a] p-6 rounded border border-[#2a2a2a]">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-semibold">Trade History</h2>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-400">
                            Showing <span id="startRow">1</span>-<span id="endRow">${Math.min(CONFIG.tradesPerPage, totalTrades)}</span> of ${totalTrades}
                        </span>
                        <div class="flex space-x-2">
                            <button id="prevPage" class="pagination-btn" onclick="changePage(-1)">
                                ← Previous
                            </button>
                            <button id="nextPage" class="pagination-btn" onclick="changePage(1)">
                                Next →
                            </button>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-[#2a2a2a]">
                                <th class="text-left py-3 px-4 text-gray-400 text-xs font-medium uppercase tracking-wider">Trade ID</th>
                                <th class="text-left py-3 px-4 text-gray-400 text-xs font-medium uppercase tracking-wider">Date</th>
                                <th class="text-left py-3 px-4 text-gray-400 text-xs font-medium uppercase tracking-wider">Symbol</th>
                                <th class="text-left py-3 px-4 text-gray-400 text-xs font-medium uppercase tracking-wider">Side</th>
                                <th class="text-left py-3 px-4 text-gray-400 text-xs font-medium uppercase tracking-wider">Entry</th>
                                <th class="text-left py-3 px-4 text-gray-400 text-xs font-medium uppercase tracking-wider">Exit</th>
                                <th class="text-left py-3 px-4 text-gray-400 text-xs font-medium uppercase tracking-wider">P&L</th>
                                <th class="text-left py-3 px-4 text-gray-400 text-xs font-medium uppercase tracking-wider">Balance</th>
                                ${CONFIG.showScreenshots ? '<th class="text-left py-3 px-4 text-gray-400 text-xs font-medium uppercase tracking-wider">Chart</th>' : ''}
                            </tr>
                        </thead>
                        <tbody id="tradesTableBody">
                            <!-- Trades will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ═══ FOOTER ═══ -->
            <div class="mt-8 bg-[#1a1a1a] p-4 rounded border border-[#2a2a2a]">
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse mr-3"></div>
                        <div>
                            <p class="text-sm text-gray-400">
                                📊 Live dashboard connected to Google Sheets
                            </p>
                            <p class="text-xs text-gray-500">
                                Last updated: ${new Date().toLocaleString()} • 
                                ${CONFIG.autoRefresh ? `Auto-refresh: ${CONFIG.autoRefreshInterval}min` : 'Manual refresh'} • 
                                ${trades.length} trades loaded
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ═══════════════════════════════════════════════════════════════════════════════
        // 📊 TRADE DATA AND PAGINATION
        // ═══════════════════════════════════════════════════════════════════════════════
        
        const allTrades = ${JSON.stringify(trades.slice().reverse())};
        const tradesPerPage = ${CONFIG.tradesPerPage};
        let currentPage = 1;
        const totalPages = Math.ceil(allTrades.length / tradesPerPage);
        
        // Helper function to convert Google Drive links
        function convertGoogleDriveLink(url) {
            if (!url) return null;
            const match = url.match(/\\/file\\/d\\/([a-zA-Z0-9_-]+)/);
            if (match && match[1]) {
                return \`https://drive.google.com/uc?export=view&id=\${match[1]}\`;
            }
            return url;
        }
        
        function displayTrades(page) {
            const startIndex = (page - 1) * tradesPerPage;
            const endIndex = Math.min(startIndex + tradesPerPage, allTrades.length);
            const tradesToShow = allTrades.slice(startIndex, endIndex);
            
            const tbody = document.getElementById('tradesTableBody');
            tbody.innerHTML = tradesToShow.map(trade => {
                const pnl = parseFloat(trade['p_l'] || 0);
                const screenshotUrl = convertGoogleDriveLink(trade.screenshot_url_A || trade.screenshot_url_B || trade.screenshot_url_C);
                
                return \`
                    <tr class="border-b border-[#2a2a2a] hover:bg-[#222222] transition-colors">
                        <td class="py-3 px-4 text-sm font-medium">\${trade.trade_id}</td>
                        <td class="py-3 px-4 text-sm text-gray-300">\${trade.date}</td>
                        <td class="py-3 px-4 text-sm font-medium">\${trade.symbol}</td>
                        <td class="py-3 px-4 text-sm \${trade.side === 'Long' || trade.side === 'BUY' ? 'text-green-400' : 'text-red-400'}">\${trade.side}</td>
                        <td class="py-3 px-4 text-sm text-gray-300">\${parseFloat(trade.entry_price || 0).toFixed(2)}</td>
                        <td class="py-3 px-4 text-sm text-gray-300">\${parseFloat(trade.exit_price || 0).toFixed(2)}</td>
                        <td class="py-3 px-4 text-sm font-bold \${pnl >= 0 ? 'text-green-400' : 'text-red-400'}">
                            \${pnl >= 0 ? '+' : ''}$\${Math.abs(pnl).toFixed(2)}
                        </td>
                        <td class="py-3 px-4 text-sm font-medium">
                            \${trade.Balance ? \`$\${parseFloat(trade.Balance).toFixed(2)}\` : '-'}
                        </td>
                        ${CONFIG.showScreenshots ? `
                        <td class="py-3 px-4 text-sm relative">
                            \${screenshotUrl ? \`
                                <div class="screenshot-link">
                                    <span style="cursor: pointer;">📸 View</span>
                                    <div class="screenshot-preview">
                                        <img src="\${screenshotUrl}" 
                                             alt="Trade Screenshot" 
                                             onerror="this.style.display='none'; this.parentElement.innerHTML='Failed to load';">
                                    </div>
                                </div>\` : '<span class="text-gray-500">-</span>'
                            }
                        </td>
                        ` : ''}
                    </tr>
                \`;
            }).join('');
            
            // Update pagination info
            document.getElementById('startRow').textContent = startIndex + 1;
            document.getElementById('endRow').textContent = endIndex;
            
            // Update button states
            document.getElementById('prevPage').disabled = page === 1;
            document.getElementById('nextPage').disabled = page === totalPages;
        }
        
        // ═══════════════════════════════════════════════════════════════════════════════
        // 📊 CHART CONFIGURATION & RENDERING
        // ═══════════════════════════════════════════════════════════════════════════════

        // Initialize charts when page loads
        window.addEventListener('load', function() {
            console.log('Window loaded, initializing dashboard...');
            
            try {
                // Display initial trades
                displayTrades(currentPage);
                console.log('Trades displayed successfully');
            } catch (error) {
                console.error('Error displaying trades:', error);
            }
            
            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.error('Chart.js not loaded!');
                return;
            }
            
            // Chart.js default configuration for dark theme
            Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
            Chart.defaults.color = '#9ca3af';
            Chart.defaults.borderColor = '#2a2a2a';

            const chartConfig = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#1a1a1a',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#3a3a3a',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        padding: 12
                    }
                },
                scales: {
                    y: {
                        ticks: { 
                            color: '#9ca3af',
                            font: { size: 11 }
                        },
                        grid: { 
                            color: '#2a2a2a',
                            drawBorder: false
                        },
                        border: { display: false }
                    },
                    x: {
                        ticks: { 
                            color: '#9ca3af',
                            font: { size: 11 }
                        },
                        grid: { 
                            color: '#2a2a2a',
                            drawBorder: false
                        },
                        border: { display: false }
                    }
                },
                animation: { duration: 1000, easing: 'easeInOutQuart' }
            };

            // Chart data
            const chartData = {
                symbols: ${JSON.stringify(symbolData)},
                weekdays: ${JSON.stringify(weekdayData)},
                hours: ${JSON.stringify(hourData)},
                equity: ${JSON.stringify(equityData)}
            };

            try {
                // Performance by Symbol Chart
                const symbolCanvas = document.getElementById('symbolChart');
                if (symbolCanvas) {
                    const symbolKeys = Object.keys(chartData.symbols);
                    if (symbolKeys.length > 0) {
                        new Chart(symbolCanvas, {
                            type: 'bar',
                            data: {
                                labels: symbolKeys,
                                datasets: [{
                                    label: 'P&L by Symbol',
                                    data: symbolKeys.map(symbol => chartData.symbols[symbol].pnl),
                                    backgroundColor: symbolKeys.map(symbol => 
                                        chartData.symbols[symbol].pnl >= 0 ? '#10b981' : '#ef4444'
                                    ),
                                    borderRadius: 4,
                                    borderSkipped: false
                                }]
                            },
                            options: {
                                ...chartConfig,
                                plugins: {
                                    ...chartConfig.plugins,
                                    tooltip: {
                                        ...chartConfig.plugins.tooltip,
                                        callbacks: {
                                            title: (items) => items[0].label,
                                            label: (item) => {
                                                const symbol = item.label;
                                                const data = chartData.symbols[symbol];
                                                return [
                                                    \`P&L: $\${data.pnl.toFixed(2)}\`,
                                                    \`Trades: \${data.trades}\`,
                                                    \`Win Rate: \${((data.wins / data.trades) * 100).toFixed(1)}%\`
                                                ];
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                }

                // Weekday Performance Chart
                const weekdayCanvas = document.getElementById('weekdayChart');
                if (weekdayCanvas) {
                    const weekdays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                    new Chart(weekdayCanvas, {
                        type: 'bar',
                        data: {
                            labels: weekdays,
                            datasets: [{
                                label: 'P&L by Weekday',
                                data: weekdays.map(day => chartData.weekdays[day]?.pnl || 0),
                                backgroundColor: weekdays.map(day => 
                                    (chartData.weekdays[day]?.pnl || 0) >= 0 ? '#10b981' : '#ef4444'
                                ),
                                borderRadius: 4,
                                borderSkipped: false
                            }]
                        },
                        options: {
                            ...chartConfig,
                            plugins: {
                                ...chartConfig.plugins,
                                tooltip: {
                                    ...chartConfig.plugins.tooltip,
                                    callbacks: {
                                        label: (item) => {
                                            const day = weekdays[item.dataIndex];
                                            const data = chartData.weekdays[day];
                                            return data ? [
                                                \`P&L: $\${data.pnl.toFixed(2)}\`,
                                                \`Trades: \${data.trades}\`
                                            ] : 'No trades';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }

                // Hour Performance Chart
                const hourCanvas = document.getElementById('hourChart');
                if (hourCanvas) {
                    const hourLabels = [];
                    for (let i = 0; i < 24; i++) {
                        hourLabels.push(i.toString().padStart(2, '0') + ':00');
                    }
                    
                    new Chart(hourCanvas, {
                        type: 'bar',
                        data: {
                            labels: hourLabels,
                            datasets: [{
                                label: 'P&L by Hour',
                                data: hourLabels.map((_, hour) => chartData.hours[hour]?.pnl || 0),
                                backgroundColor: hourLabels.map((_, hour) => 
                                    (chartData.hours[hour]?.pnl || 0) >= 0 ? '#10b981' : '#ef4444'
                                ),
                                borderRadius: 4,
                                borderSkipped: false
                            }]
                        },
                        options: {
                            ...chartConfig,
                            scales: {
                                ...chartConfig.scales,
                                x: {
                                    ...chartConfig.scales.x,
                                    ticks: {
                                        ...chartConfig.scales.x.ticks,
                                        maxRotation: 45,
                                        minRotation: 45,
                                        autoSkip: true,
                                        maxTicksLimit: 12
                                    }
                                }
                            },
                            plugins: {
                                ...chartConfig.plugins,
                                tooltip: {
                                    ...chartConfig.plugins.tooltip,
                                    callbacks: {
                                        label: (item) => {
                                            const hour = item.dataIndex;
                                            const data = chartData.hours[hour];
                                            return data ? [
                                                \`P&L: $\${data.pnl.toFixed(2)}\`,
                                                \`Trades: \${data.trades}\`
                                            ] : 'No trades';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }

                // Equity Curve Chart
                const equityCanvas = document.getElementById('equityChart');
                if (equityCanvas && chartData.equity.length > 0) {
                    new Chart(equityCanvas, {
                        type: 'line',
                        data: {
                            labels: chartData.equity.map(point => \`Trade \${point.trade}\`),
                            datasets: [{
                                label: 'Account Balance',
                                data: chartData.equity.map(point => point.equity),
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: chartData.equity.map(point => 
                                    point.pnl >= 0 ? '#10b981' : '#ef4444'
                                ),
                                pointBorderColor: '#1a1a1a',
                                pointBorderWidth: 2,
                                pointRadius: 4,
                                pointHoverRadius: 6
                            }]
                        },
                        options: {
                            ...chartConfig,
                            plugins: {
                                ...chartConfig.plugins,
                                tooltip: {
                                    ...chartConfig.plugins.tooltip,
                                    callbacks: {
                                        title: (items) => items[0].label,
                                        label: (item) => {
                                            const point = chartData.equity[item.dataIndex];
                                            return [
                                                \`Balance: $\${point.equity.toFixed(2)}\`,
                                                \`P&L: \${point.pnl >= 0 ? '+' : ''}$\${point.pnl.toFixed(2)}\`,
                                                \`Date: \${point.date}\`
                                            ];
                                        }
                                    }
                                }
                            },
                            scales: {
                                ...chartConfig.scales,
                                y: {
                                    ...chartConfig.scales.y,
                                    ticks: {
                                        ...chartConfig.scales.y.ticks,
                                        callback: function(value) {
                                            return '$' + value.toLocaleString();
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error creating charts:', error);
            }

            // ═══════════════════════════════════════════════════════════════════════════════
            // ⌨️ KEYBOARD SHORTCUTS
            // ═══════════════════════════════════════════════════════════════════════════════
            // r: Reload dashboard
            // Arrow Left/Right: Navigate trade pages
            // Shift + Arrow Left/Right: Navigate calendar months

            ${CONFIG.enableKeyboardShortcuts ? `
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey || e.metaKey) return;
                
                switch(e.key.toLowerCase()) {
                    case 'r':
                        e.preventDefault();
                        window.location.reload();
                        break;
                    case 'arrowleft':
                        e.preventDefault();
                        changePage(-1);
                        break;
                    case 'arrowright':
                        e.preventDefault();
                        changePage(1);
                        break;
                }
            });
            ` : ''}

            console.log('📊 Trading Dashboard v3.1 loaded successfully!');
            console.log('💰 Net P&L (after fees):', '$${netPLAfterFees.toFixed(2)}');
            console.log('🎯 Win Rate:', '${winRate.toFixed(1)}%');
            console.log('📈 Total Trades:', ${totalTrades});
            console.log('💸 Total Fees:', '$${totalFees.toFixed(2)}');
        });
    </script>
</body>
</html>`;

  // ═══════════════════════════════════════════════════════════════════════════════
  // 📤 RETURN GENERATED DASHBOARD
  // ═══════════════════════════════════════════════════════════════════════════════

  return [{
    json: {
      html: dashboardHTML,
      metadata: {
        totalTrades,
        netPL: netPL.toFixed(2),
        netPLAfterFees: netPLAfterFees.toFixed(2),
        totalFees: totalFees.toFixed(2),
        winRate: winRate.toFixed(1),
        profitFactor: profitFactor.toFixed(2),
        currentBalance: currentBalance.toFixed(2),
        generatedAt: new Date().toISOString(),
        dashboardVersion: '3.2',
        features: Object.keys(CONFIG).filter(key => CONFIG[key])
      }
    }
  }];

} catch (error) {
  // ═══════════════════════════════════════════════════════════════════════════════
  // ❌ ERROR HANDLING
  // ═══════════════════════════════════════════════════════════════════════════════
  
  console.error('Dashboard error:', error);
  
  return [{
    json: {
      html: `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Error</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>body { margin: 0; background-color: #0a0a0a; }</style>
</head>
<body class="bg-[#0a0a0a] text-white p-6">
    <div class="max-w-2xl mx-auto text-center">
        <div class="bg-red-900/30 border border-red-600/50 p-8 rounded-lg">
            <div class="text-6xl mb-4">⚠️</div>
            <h1 class="text-2xl font-bold mb-4">Dashboard Generation Error</h1>
            <p class="text-gray-300 mb-6">There was an error generating your trading dashboard.</p>
            <div class="bg-[#1a1a1a] p-4 rounded text-left mb-6">
                <h3 class="font-bold text-red-400 mb-2">Error Details:</h3>
                <p class="text-sm text-gray-300 font-mono">${error.message}</p>
                <p class="text-xs text-gray-500 mt-2">Stack: ${error.stack}</p>
            </div>
            <button onclick="window.location.reload()" 
                    class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded font-medium mt-6">
                🔄 Try Again
            </button>
        </div>
    </div>
</body>
</html>`,
      error: error.message,
      timestamp: new Date().toISOString()
    }
  }];
}
